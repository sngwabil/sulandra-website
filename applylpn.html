<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sulandra Admin | Operations Portal</title>
  <meta name="description" content="Admin portal to manage applicants, employees, scheduling, time tracking, documents, and operations." />

  <link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="shortcut icon" href="/favicon.ico">

  <style>
    :root {
      --primary: #004b8d;
      --secondary: #0077c8;
      --accent: #d14124;
      --text: #333333;
      --bg-light: #f7f9fc;
      --white: #ffffff;
      --border: #e6e6e6;
      --muted: #666;
      --shadow: 0 6px 20px rgba(0,0,0,0.08);
      --radius: 12px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
      background: var(--bg-light);
      line-height: 1.6;
    }
    a { color: inherit; }

    /* --- ALERT BAR (like index) --- */
    .alert-bar {
      background: var(--accent);
      color: #fff;
      text-align: center;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 800;
    }

    /* --- HEADER (match index structure) --- */
    header { border-bottom: 1px solid #ddd; position: sticky; top: 0; background: white; z-index: 1000; }
    .top-nav {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      height: 80px;
      gap: 14px;
    }
    .logo {
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--primary);
      font-weight: 800;
      min-width: 0;
    }
    .logo img{
      width: 240px;
      height: auto;
      max-height: 100%;
      object-fit: contain;
      display: block;
    }
    .sr-only{
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .header-tools {
      display: flex;
      gap: 12px;
      align-items: center;
      font-size: 14px;
      font-weight: 600;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .pill {
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      font-weight: 800;
      color: #444;
      white-space: nowrap;
    }
    .btn-cta {
      background: var(--primary);
      color: white !important;
      padding: 10px 16px;
      border-radius: 4px;
      text-decoration: none;
      border: 0;
      cursor: pointer;
      font-weight: 800;
      font-size: 14px;
    }
    .btn-cta.secondary {
      background: var(--secondary);
    }
    .btn-cta.danger {
      background: var(--accent);
    }

    .main-nav { background: #fff; border-top: 1px solid #eee; }
    .nav-links {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      list-style: none;
      padding: 0 20px;
      gap: 2px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .nav-links::-webkit-scrollbar { display: none; }
    .nav-links a {
      display: block;
      padding: 15px 18px;
      text-decoration: none;
      color: var(--text);
      font-weight: 700;
      font-size: 15px;
      white-space: nowrap;
      border-radius: 6px;
      margin: 6px 0;
      cursor: pointer;
    }
    .nav-links a:hover { color: var(--primary); background: #f0f4f8; }
    .nav-links a.active { color: var(--primary); background: #eef6ff; border: 1px solid #cfe4fb; }

    /* --- LAYOUT --- */
    .container {
      max-width: 1200px;
      margin: 22px auto 70px;
      padding: 0 20px;
    }

    .grid {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 16px;
      align-items: start;
      margin-top: 16px;
    }
    @media (max-width: 980px){
      .grid { grid-template-columns: 1fr; }
    }

    .card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: var(--shadow);
      padding: 18px;
    }

    .sidebar .section-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .5px;
      color: var(--muted);
      font-weight: 900;
      margin-bottom: 10px;
    }

    .side-btns {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .side-btn {
      text-align: left;
      width: 100%;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 900;
      color: #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .side-btn:hover { background: #f7fbff; border-color: #cfe4fb; color: var(--primary); }
    .side-btn.active { background: #eef6ff; border-color: #cfe4fb; color: var(--primary); }
    .side-btn small { color: var(--muted); font-weight: 800; }

    h1 { color: var(--primary); font-size: 22px; margin-bottom: 6px; }
    .sub { color: var(--muted); font-size: 13px; }

    /* --- TABLES / FIELDS --- */
    .toolbar{
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }
    .filters{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .field{
      display:flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px 10px;
      background:#fff;
    }
    .field label{
      font-size:12px;
      font-weight:900;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.4px;
    }
    input[type="search"], input[type="text"], select{
      border:0;
      outline:none;
      background:transparent;
      font-size:13px;
      min-width: 180px;
    }
    select{ min-width: 150px; }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top: 14px;
      background:#fff;
      border:1px solid rgba(230,230,230,.9);
      border-radius: 10px;
      overflow:hidden;
    }
    thead th{
      text-align:left;
      padding:12px;
      background:#edf2f7;
      color:#4a5568;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.4px;
    }
    tbody td{
      padding:12px;
      border-bottom:1px solid #edf2f7;
      font-size:13px;
      vertical-align:top;
    }
    tbody tr:hover{ background:#fbfdff; }
    .muted { color: var(--muted); }

    .btn {
      border: 0;
      cursor: pointer;
      border-radius: 10px;
      padding: 8px 10px;
      font-weight: 900;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-secondary { background: var(--secondary); color: #fff; }
    .btn-ghost { background: transparent; border: 1px solid var(--border); color: #333; }
    .btn-danger { background: #fee2e2; color:#7f1d1d; border:1px solid #fecaca; }
    .btn-disabled { opacity: .55; cursor: not-allowed; }

    .status-pill{
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:900;
      display:inline-block;
      border:1px solid rgba(230,230,230,.9);
    }
    .Pending { background:#fef3c7; color:#92400e; border-color:#f59e0b33; }
    .Reviewed { background:#e0f2fe; color:#075985; border-color:#0284c733; }
    .Hired { background:#dcfce7; color:#166534; border-color:#22c55e33; }
    .Rejected { background:#fee2e2; color:#7f1d1d; border-color:#ef444433; }
    .Approved { background:#dcfce7; color:#166534; border-color:#22c55e33; }

    .score{
      font-weight:900;
      padding:4px 8px;
      border-radius:10px;
      border:1px solid rgba(230,230,230,.9);
      display:inline-block;
      min-width: 62px;
      text-align:center;
      background:#fff;
    }

    /* --- MODULES --- */
    .module { display: none; }
    .module.active { display: block; }

    /* --- MODAL --- */
    #detailsModal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      z-index:2000;
      padding:16px;
    }
    .modal{
      background:#fff;
      max-width: 920px;
      margin: 24px auto;
      border-radius: 16px;
      border:1px solid rgba(230,230,230,.9);
      box-shadow: var(--shadow);
      overflow:hidden;
      max-height: calc(100vh - 48px);
      display:flex;
      flex-direction:column;
    }
    .modal-head{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid rgba(230,230,230,.9);
      background:#fcfcfd;
    }
    .modal-title{
      font-weight:950;
      font-size:14px;
      color:#111;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .modal-body{ padding:16px; overflow:auto; }
    .close-x{
      font-size:22px;
      line-height:1;
      cursor:pointer;
      padding:6px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
    }
    .close-x:hover{ background:#f9fafb; }

    .kvgrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    @media (max-width: 820px){ .kvgrid{ grid-template-columns: 1fr; } }
    .kv{
      border:1px solid rgba(230,230,230,.9);
      border-radius:14px;
      padding:12px;
      background:#fff;
    }
    .kv .k{
      font-size:11px;
      font-weight:900;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.4px;
      margin-bottom:6px;
    }
    .kv .v{
      font-size:13px;
      font-weight:800;
      word-break:break-word;
    }
    .section{
      margin-top:14px;
      border-top:1px dashed rgba(230,230,230,.9);
      padding-top:14px;
    }
    .section h3{
      margin:0 0 8px;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.5px;
      color:var(--primary);
    }
    .list{
      border:1px solid rgba(230,230,230,.9);
      border-radius:14px;
      overflow:hidden;
    }
    .list .rowi{
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border-bottom:1px solid rgba(230,230,230,.7);
      font-size:13px;
      background:#fff;
    }
    .list .rowi:last-child{ border-bottom:0; }
    .list .rowi .meta{ color:var(--muted); font-weight:700; }
    .list a{ color:var(--secondary); font-weight:900; }

    /* --- TOAST --- */
    .toast{
      position: fixed;
      right: 16px; bottom: 16px;
      width: min(420px, calc(100vw - 32px));
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 14px;
      display:none;
      z-index: 2500;
    }
    .toast.show{ display:block; }
    .toast strong{ display:block; margin-bottom:4px; }
    .toast small{ color: var(--muted); }

    /* --- MOBILE HEADER --- */
    @media (max-width: 800px) {
      .top-nav { padding: 12px 14px; height: 72px; }
      .logo img { width: 200px; max-height: 100%; }
      .header-tools .hide-mobile { display:none; }
      .container { padding: 0 14px; }
    }
  </style>
</head>

<body>
  <div class="alert-bar">Admin Console — confidential. Authorized staff only.</div>

  <header>
    <div class="top-nav">
      <a href="index.html" class="logo" aria-label="Sulandra Health Home">
        <img src="assets/mainlogo.png" alt="Sulandra Health Logo">
        <span class="sr-only">Sulandra Health</span>
      </a>

      <div class="header-tools">
        <span class="pill hide-mobile" id="adminEmailPill">Admin</span>
        <span class="pill hide-mobile" id="livePill">Live: connecting…</span>
        <button class="btn-cta secondary hide-mobile" id="refreshBtn" type="button">Refresh</button>
        <button class="btn-cta hide-mobile" id="exportBtn" type="button">Export CSV</button>
        <button class="btn-cta danger" id="btnAdminSignOut" type="button">Sign Out</button>
      </div>
    </div>

    <!-- Top module quick-nav (matches main site nav feel) -->
    <nav class="main-nav">
      <ul class="nav-links" id="topModuleNav">
        <li><a data-module="dashboard" class="active">Dashboard</a></li>
        <li><a data-module="applicants">Applicants</a></li>
        <li><a data-module="employees">Employees</a></li>
        <li><a data-module="scheduling">Scheduling</a></li>
        <li><a data-module="time">Time & Attendance</a></li>
        <li><a data-module="documents">Documents</a></li>
        <li><a data-module="reports">Reports</a></li>
        <li><a data-module="settings">Settings</a></li>
      </ul>
    </nav>
  </header>

  <main class="container">
    <div class="grid">
      <!-- Sidebar -->
      <aside class="card sidebar">
        <div class="section-title">Operations</div>
        <div class="side-btns" id="sideModuleNav">
          <button class="side-btn active" type="button" data-module="dashboard">Dashboard <small>Overview</small></button>
          <button class="side-btn" type="button" data-module="applicants">Applicants <small>Hiring</small></button>
          <button class="side-btn" type="button" data-module="employees">Employees <small>Profiles</small></button>
          <button class="side-btn" type="button" data-module="scheduling">Scheduling <small>Shifts</small></button>
          <button class="side-btn" type="button" data-module="time">Time & Attendance <small>Clock-ins</small></button>
          <button class="side-btn" type="button" data-module="documents">Documents <small>Compliance</small></button>
          <button class="side-btn" type="button" data-module="reports">Reports <small>Audit</small></button>
          <button class="side-btn" type="button" data-module="settings">Settings <small>Roles</small></button>
        </div>

        <div class="section-title" style="margin-top:14px;">Notes</div>
        <p class="sub">
          Applicants is only one part of operations. This portal will also manage schedules, timekeeping, documents,
          training, audits, and role-based access.
        </p>
      </aside>

      <!-- Content -->
      <section style="display:flex; flex-direction:column; gap:16px;">

        <!-- Dashboard -->
        <section class="card module active" id="module-dashboard">
          <h1>Dashboard</h1>
          <p class="sub">Quick overview. Next: counts, alerts, anomalies (late clock-ins, missing docs, expiring licenses).</p>

          <div class="toolbar">
            <div class="filters">
              <span class="pill">Applicants: <span id="kpiApplicants">—</span></span>
              <span class="pill">Employees: <span id="kpiEmployees">—</span></span>
              <span class="pill">Pending Timesheets: <span id="kpiTimesheets">—</span></span>
            </div>
            <div class="sub">Use the sidebar or top menu to switch modules.</div>
          </div>
        </section>

        <!-- Applicants -->
        <section class="module" id="module-applicants">
          <section class="card">
            <h1>Applicants</h1>
            <p class="sub">Review applications, view uploaded documents, update status, and hire candidates into employee profiles.</p>

            <div class="toolbar">
              <div class="filters">
                <div class="field">
                  <label for="search">Search</label>
                  <input id="search" type="search" placeholder="Name, email, phone…" />
                </div>

                <div class="field">
                  <label for="statusFilter">Status</label>
                  <select id="statusFilter">
                    <option value="all">All</option>
                    <option value="Pending">Pending</option>
                    <option value="Reviewed">Reviewed</option>
                    <option value="Hired">Hired</option>
                    <option value="Rejected">Rejected</option>
                  </select>
                </div>

                <div class="field">
                  <label for="jobFilter">Job</label>
                  <select id="jobFilter">
                    <option value="all">All</option>
                    <option value="LPN">LPN</option>
                    <option value="DSP">DSP</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
              </div>

              <div class="sub" id="countLabel">0 applications</div>
            </div>

            <table aria-label="Applications table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Applicant</th>
                  <th>Job</th>
                  <th>Score</th>
                  <th>Status</th>
                  <th style="width:260px;">Actions</th>
                </tr>
              </thead>
              <tbody id="applicantTable">
                <tr><td colspan="6" class="muted">Loading applications…</td></tr>
              </tbody>
            </table>
          </section>

          <section class="card" style="margin-top:16px;">
            <h1>Education Assignment</h1>
            <p class="sub">Assign training modules to a hired employee.</p>

            <div class="toolbar">
              <div class="filters">
                <div class="field">
                  <label for="employeeSelect">Employee</label>
                  <select id="employeeSelect"><option>Loading employees...</option></select>
                </div>
                <div class="field">
                  <label for="trainingInput">Training</label>
                  <input id="trainingInput" type="text" placeholder="e.g., HIPAA 2025">
                </div>
                <button class="btn btn-primary" id="assignBtn" type="button">Assign</button>
                <span class="sub" id="assignHint"></span>
              </div>
            </div>
          </section>

          <section class="card" style="margin-top:16px;">
            <h1>Timesheet Review</h1>
            <p class="sub">Approve weekly hours. Approved entries can be marked payroll-ready.</p>

            <table aria-label="Timesheets table">
              <thead>
                <tr>
                  <th>Employee</th>
                  <th>Week Ending</th>
                  <th>Hours</th>
                  <th>Pay Code</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="timesheetTable">
                <tr><td colspan="6" class="muted">Loading timesheets…</td></tr>
              </tbody>
            </table>
          </section>
        </section>

        <!-- Placeholders -->
        <section class="card module" id="module-employees">
          <h1>Employees</h1>
          <p class="sub">Employee directory, role assignment, home assignment, documents required, credentials, status.</p>
          <p class="sub">Next: searchable employee list → open profile → assign role (Admin/House Manager/Employee).</p>
        </section>

        <section class="card module" id="module-scheduling">
          <h1>Scheduling</h1>
          <p class="sub">Create schedules and assign shifts to employees/homes.</p>
          <p class="sub">Next: schedule calendar + shift templates + compare schedule vs clock-ins.</p>
        </section>

        <section class="card module" id="module-time">
          <h1>Time & Attendance</h1>
          <p class="sub">Clock-ins, breaks, late/early punches, missed shifts, approvals.</p>
          <p class="sub">Next: clock-in logs + anomaly flags.</p>
        </section>

        <section class="card module" id="module-documents">
          <h1>Documents</h1>
          <p class="sub">Track required documentation, expiration dates, and compliance workflow.</p>
          <p class="sub">Next: upload review queue + reminders.</p>
        </section>

        <section class="card module" id="module-reports">
          <h1>Reports</h1>
          <p class="sub">Audit logs, payroll export, compliance, operational metrics.</p>
        </section>

        <section class="card module" id="module-settings">
          <h1>Settings</h1>
          <p class="sub">Roles & permissions (Admin, House Manager, Employee). Control which tools appear per role.</p>
        </section>

      </section>
    </div>
  </main>

  <!-- Details Modal -->
  <div id="detailsModal" role="dialog" aria-modal="true" aria-label="Application details">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title" id="modalTitle">Application</div>
        <button class="close-x" id="closeModalBtn" type="button" aria-label="Close">×</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite">
    <strong id="toastTitle">Done</strong>
    <small id="toastBody">OK</small>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      onSnapshot,
      doc,
      updateDoc,
      setDoc,
      addDoc,
      getDoc,
      query,
      orderBy,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCi3Qtyka_PJsHT9Ln7LJZp2BCqOxW3lM8",
      authDomain: "sulandra-health-portal.firebaseapp.com",
      projectId: "sulandra-health-portal",
      storageBucket: "sulandra-health-portal.firebasestorage.app",
      messagingSenderId: "547316167712",
      appId: "1:547316167712:web:24dfc2c5bd9d0296b4f845"
    };

    const ADMIN_EMAIL = "admin@sulandrahealth.com";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /* ==========================
       AUTH GUARD (ADMIN ONLY)
       ========================== */
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.replace("employee-login.html");
        return;
      }
      const email = (user.email || "").toLowerCase();
      if (email !== ADMIN_EMAIL) {
        window.location.replace("employee-portal.html");
        return;
      }
      const pill = document.getElementById("adminEmailPill");
      if (pill) pill.textContent = email;
    });

    document.getElementById("btnAdminSignOut").addEventListener("click", async () => {
      try { await signOut(auth); } catch(e){ console.error(e); }
      window.location.replace("employee-login.html");
    });

    /* ==========================
       MODULE SWITCHING (top nav + sidebar)
       ========================== */
    const topLinks = Array.from(document.querySelectorAll('#topModuleNav a[data-module]'));
    const sideBtns = Array.from(document.querySelectorAll('#sideModuleNav button[data-module]'));

    function activateModule(key){
      topLinks.forEach(a => a.classList.toggle('active', a.dataset.module === key));
      sideBtns.forEach(b => b.classList.toggle('active', b.dataset.module === key));
      document.querySelectorAll('.module').forEach(m => m.classList.remove('active'));
      const el = document.getElementById(`module-${key}`);
      if (el) el.classList.add('active');
      // scroll nicely on mobile
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    topLinks.forEach(a => a.addEventListener('click', () => activateModule(a.dataset.module)));
    sideBtns.forEach(b => b.addEventListener('click', () => activateModule(b.dataset.module)));

    /* ==========
       Helpers
       ========== */
    const $ = (id) => document.getElementById(id);

    function toast(title, body){
      $("toastTitle").textContent = title;
      $("toastBody").textContent = body || "";
      $("toast").classList.add("show");
      setTimeout(() => $("toast").classList.remove("show"), 2600);
    }

    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function fmtDate(iso){
      if(!iso) return "N/A";
      try{
        const d = new Date(iso);
        if(Number.isNaN(d.getTime())) return String(iso).split("T")[0] || "N/A";
        return d.toISOString().split("T")[0];
      }catch(_){
        return String(iso).split("T")[0] || "N/A";
      }
    }

    function guessJobLabel(app){
      const jt = (app.jobTitle || app.fields?.jobTitle || "").toString().toLowerCase();
      if(jt.includes("practical") || jt.includes("lpn")) return "LPN";
      if(jt.includes("dsp") || jt.includes("direct support")) return "DSP";
      return jt ? "Other" : "—";
    }

    function getApplicantName(app){
      const fn = app.firstName || app.fields?.firstName || "";
      const ln = app.lastName || app.fields?.lastName || "";
      const combined = `${fn} ${ln}`.trim();
      return combined || "Unknown";
    }

    function getApplicantEmail(app){ return app.email || app.fields?.email || "—"; }
    function getApplicantPhone(app){ return app.phone || app.fields?.phone || "—"; }
    function getStatus(app){ return (app.status || "Pending").toString(); }

    function getScore(app){
      const a = app.assessment?.score;
      if(typeof a === "number") return a;
      const b = app.fields?.assessmentScore;
      const n = Number(b);
      return Number.isFinite(n) ? n : 0;
    }

    function normalizeAppRecord(docId, data, source){ return { id: docId, source, ...data }; }

    function downloadText(filename, text){
      const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function toCSV(rows){
      const esc = (v) => `"${String(v ?? "").replaceAll('"', '""')}"`;
      const header = ["date","name","email","phone","job","status","score","collection","id"];
      const lines = [header.join(",")];
      for(const r of rows){
        lines.push([
          esc(r.date), esc(r.name), esc(r.email), esc(r.phone),
          esc(r.job), esc(r.status), esc(r.score), esc(r.collection), esc(r.id)
        ].join(","));
      }
      return lines.join("\n");
    }

    /* ==========
       Applications
       ========== */
    const collectionsToWatch = [
      { key:"applications_lpn", label:"applications_lpn" },
      { key:"applications", label:"applications" }
    ];
    const submissionsCollection = { key:"applications_lpn_submissions", label:"applications_lpn_submissions" };

    let apps = [];
    let rawApps = [];
    let submissions = [];
    let unsubscribers = [];

    function setLiveState(text){
      const p = $("livePill");
      if(p) p.textContent = text;
    }

    function stopSnapshots(){
      unsubscribers.forEach(fn => { try{ fn(); }catch(_){} });
      unsubscribers = [];
    }

    function startSnapshots(){
      stopSnapshots();
      setLiveState("Live: connected");

      for(const c of collectionsToWatch){
        const qy = query(collection(db, c.key), orderBy("submittedAtISO", "desc"));
        const unsub = onSnapshot(qy, (snap) => {
          const next = [];
          snap.forEach(d => next.push(normalizeAppRecord(d.id, d.data(), c.key)));
          rawApps = rawApps.filter(x => x.source !== c.key).concat(next);
          rebuildMerged();
          renderApplicants();
          updateKPIs();
        }, (err) => {
          console.error(err);
          setLiveState("Live: error");
          toast("Live error", "Could not load applications.");
        });
        unsubscribers.push(unsub);
      }

      const qsub = query(collection(db, submissionsCollection.key), orderBy("submittedAtISO", "desc"));
      const unsubSub = onSnapshot(qsub, (snap) => {
        const next = [];
        snap.forEach(d => next.push(normalizeAppRecord(d.id, d.data(), submissionsCollection.key)));
        submissions = next;
        rebuildMerged();
        renderApplicants();
        updateKPIs();
      }, (err) => console.error(err));
      unsubscribers.push(unsubSub);
    }

    function findUploadedFilesFor(appId){
      const s = submissions.find(x => x.applicationId === appId);
      if(s && Array.isArray(s.uploadedFiles)) return s.uploadedFiles;
      const base = rawApps.find(x => x.id === appId && (x.source === "applications"));
      if(base && Array.isArray(base.uploadedFiles)) return base.uploadedFiles;
      const base2 = rawApps.find(x => x.id === appId);
      if(base2 && Array.isArray(base2.files)) return base2.files;
      return [];
    }

    function rebuildMerged(){
      apps = rawApps
        .filter(x => x.source !== submissionsCollection.key)
        .map(x => {
          const dateISO = x.submittedAtISO || x.fields?.submittedAtISO || "";
          const status = getStatus(x);
          const name = getApplicantName(x);
          const email = getApplicantEmail(x);
          const phone = getApplicantPhone(x);
          const job = guessJobLabel(x);
          const score = getScore(x);
          const uploadedFiles = findUploadedFilesFor(x.id);

          return {
            id: x.id,
            collection: x.source,
            dateISO,
            date: fmtDate(dateISO),
            name,
            email,
            phone,
            job,
            status,
            score,
            uploadedFiles,
            raw: x
          };
        })
        .sort((a,b) => (b.dateISO || "").localeCompare(a.dateISO || ""));
    }

    function getFilteredApplicants(){
      const q = ($("search")?.value || "").trim().toLowerCase();
      const status = $("statusFilter")?.value || "all";
      const job = $("jobFilter")?.value || "all";

      return apps.filter(a => {
        const matchesQ = !q || (
          a.name.toLowerCase().includes(q) ||
          String(a.email).toLowerCase().includes(q) ||
          String(a.phone).toLowerCase().includes(q)
        );

        const matchesStatus = (status === "all") || (a.status === status);
        const matchesJob = (job === "all") || (a.job === job);

        return matchesQ && matchesStatus && matchesJob;
      });
    }

    function renderApplicants(){
      const tbody = $("applicantTable");
      if(!tbody) return;

      const rows = getFilteredApplicants();
      const count = $("countLabel");
      if(count) count.textContent = `${rows.length} application${rows.length === 1 ? "" : "s"}`;

      if(rows.length === 0){
        tbody.innerHTML = `<tr><td colspan="6" class="muted">No applications match your filters.</td></tr>`;
        return;
      }

      tbody.innerHTML = "";
      for(const a of rows){
        const tr = document.createElement("tr");

        const hireBtn = (a.status !== "Hired")
          ? `<button class="btn btn-secondary" data-action="hire" data-id="${escapeHtml(a.id)}" data-col="${escapeHtml(a.collection)}">HIRE</button>`
          : `<button class="btn btn-ghost btn-disabled" type="button" disabled>HIRED</button>`;

        tr.innerHTML = `
          <td>${escapeHtml(a.date)}</td>
          <td>
            <div style="font-weight:900;">${escapeHtml(a.name)}</div>
            <div class="muted" style="font-size:12px;">${escapeHtml(a.email)}</div>
          </td>
          <td>
            <div style="font-weight:900;">${escapeHtml(a.job)}</div>
            <div class="muted" style="font-size:12px;">${escapeHtml(a.collection)}</div>
          </td>
          <td><span class="score">${escapeHtml(String(a.score))}/10</span></td>
          <td><span class="status-pill ${escapeHtml(a.status)}">${escapeHtml(a.status)}</span></td>
          <td>
            <button class="btn btn-primary" data-action="view" data-id="${escapeHtml(a.id)}" data-col="${escapeHtml(a.collection)}">View</button>
            <button class="btn btn-ghost" data-action="status" data-id="${escapeHtml(a.id)}" data-col="${escapeHtml(a.collection)}">Status</button>
            ${hireBtn}
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    /* ==========
       Modal
       ========== */
    function openModal(){ $("detailsModal").style.display = "block"; }
    function closeModal(){ $("detailsModal").style.display = "none"; }

    $("closeModalBtn")?.addEventListener("click", closeModal);
    $("detailsModal")?.addEventListener("click", (e) => { if(e.target === $("detailsModal")) closeModal(); });
    document.addEventListener("keydown", (e) => { if(e.key === "Escape") closeModal(); });

    async function viewApplication(appId, sourceCollection){
      const baseRef = doc(db, sourceCollection, appId);
      const snap = await getDoc(baseRef);
      if(!snap.exists()){
        toast("Not found", "Application could not be loaded.");
        return;
      }

      const data = snap.data();
      const row = apps.find(x => x.id === appId && x.collection === sourceCollection) || null;

      const name = getApplicantName(data);
      const email = getApplicantEmail(data);
      const phone = getApplicantPhone(data);
      const status = getStatus(data);
      const job = data.jobTitle || data.fields?.jobTitle || "—";

      const fields = data.fields || {};
      const address = [
        fields.address1 || data.address1 || "",
        fields.address2 || data.address2 || "",
        fields.city || data.city || "",
        fields.state || data.state || "",
        fields.zip || data.zip || ""
      ].filter(Boolean).join(", ") || "—";

      const experiences = data.experiences || data.fields?.experiences || row?.raw?.experiences || [];
      const references = data.references || data.fields?.references || row?.raw?.references || [];
      const uploadedFiles = row ? row.uploadedFiles : findUploadedFilesFor(appId);

      const expHtml = Array.isArray(experiences) && experiences.length ? experiences.map((e,i) => `
        <div class="rowi">
          <div>
            <div style="font-weight:900;">#${i+1} ${escapeHtml(e.title || "")} ${e.employer ? "— " + escapeHtml(e.employer) : ""}</div>
            <div class="meta">${escapeHtml((e.start || "—") + " → " + (e.end || "—"))}</div>
          </div>
          <div class="meta">${escapeHtml(e.contactOk ? "Contact: " + e.contactOk : "")}</div>
        </div>
      `).join("") : `<div class="rowi"><div class="meta">No experience entries.</div><div class="meta">—</div></div>`;

      const refHtml = Array.isArray(references) && references.length ? references.map((r,i) => `
        <div class="rowi">
          <div>
            <div style="font-weight:900;">#${i+1} ${escapeHtml(r.name || "")} ${r.relation ? "— " + escapeHtml(r.relation) : ""}</div>
            <div class="meta">${escapeHtml((r.email || "—") + " • " + (r.phone || "—"))}</div>
          </div>
          <div class="meta">—</div>
        </div>
      `).join("") : `<div class="rowi"><div class="meta">No references.</div><div class="meta">—</div></div>`;

      let filesHtml = "";
      if(uploadedFiles && uploadedFiles.length){
        const items = uploadedFiles.map(f => {
          const url = f.url || f.downloadURL || "";
          const label = f.field || f.label || "File";
          const nm = f.name || "document";
          return `
            <div class="rowi">
              <div>
                <div style="font-weight:900;">${escapeHtml(label)}: ${escapeHtml(nm)}</div>
                <div class="meta">${escapeHtml(f.type || "Uploaded")}</div>
              </div>
              <div class="meta">
                ${url ? `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">Open</a>` : "—"}
              </div>
            </div>
          `;
        }).join("");
        filesHtml = `<div class="section"><h3>Uploaded Documents</h3><div class="list">${items}</div></div>`;
      } else {
        filesHtml = `<div class="section"><h3>Uploaded Documents</h3><div class="list"><div class="rowi"><div class="meta">No uploaded files found.</div><div class="meta">—</div></div></div></div>`;
      }

      $("modalTitle").innerHTML = `
        ${escapeHtml(name)}
        <span class="status-pill ${escapeHtml(status)}">${escapeHtml(status)}</span>
        <span class="pill">ID: ${escapeHtml(appId)}</span>
      `;

      $("modalBody").innerHTML = `
        <div class="kvgrid">
          <div class="kv"><div class="k">Email</div><div class="v">${escapeHtml(email)}</div></div>
          <div class="kv"><div class="k">Phone</div><div class="v">${escapeHtml(phone)}</div></div>
          <div class="kv"><div class="k">Job Title</div><div class="v">${escapeHtml(job)}</div></div>
          <div class="kv"><div class="k">Address</div><div class="v">${escapeHtml(address)}</div></div>
        </div>

        <div class="section">
          <h3>Work Experience</h3>
          <div class="list">${expHtml}</div>
        </div>

        <div class="section">
          <h3>References</h3>
          <div class="list">${refHtml}</div>
        </div>

        ${filesHtml}

        <div class="section">
          <h3>Quick Actions</h3>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn btn-secondary" id="modalMarkReviewed">Mark Reviewed</button>
            <button class="btn btn-danger" id="modalMarkRejected">Reject</button>
            <button class="btn btn-primary" id="modalHire">Hire</button>
          </div>
        </div>
      `;

      $("modalMarkReviewed").addEventListener("click", () => updateStatus(appId, sourceCollection, "Reviewed", true));
      $("modalMarkRejected").addEventListener("click", () => updateStatus(appId, sourceCollection, "Rejected", true));
      $("modalHire").addEventListener("click", () => hireEmployee(appId, sourceCollection, true));

      openModal();
    }

    async function updateStatus(appId, sourceCollection, status, keepOpen=false){
      try{
        await updateDoc(doc(db, sourceCollection, appId), {
          status,
          statusUpdatedAt: serverTimestamp()
        });
        toast("Updated", `Status set to ${status}.`);
        if(!keepOpen) closeModal();
      }catch(err){
        console.error(err);
        toast("Update failed", "Check permissions / Firestore rules.");
      }
    }

    async function hireEmployee(appId, sourceCollection, keepOpen=false){
      try{
        const empId = prompt("Enter the new Employee ID (e.g., SCLS-101):");
        if (!empId) return;

        const baseRef = doc(db, sourceCollection, appId);
        const snap = await getDoc(baseRef);
        if(!snap.exists()){
          toast("Not found", "Application could not be loaded.");
          return;
        }
        const appData = snap.data();
        const fields = appData.fields || {};

        await setDoc(doc(db, "employees", empId), {
          employeeId: empId,
          firstName: appData.firstName || fields.firstName || "",
          lastName: appData.lastName || fields.lastName || "",
          email: appData.email || fields.email || "",
          phone: appData.phone || fields.phone || "",
          hiredDate: new Date().toISOString(),
          status: "Active",
          assignedEducation: [],
          role: appData.jobTitle || fields.jobTitle || guessJobLabel(appData) || "Employee",
          sourceApplicationId: appId,
          sourceCollection
        }, { merge: true });

        await updateDoc(baseRef, { status: "Hired", hiredEmployeeId: empId, hiredAt: serverTimestamp() });

        toast("Hired", `Employee profile created: ${empId}`);
        if(!keepOpen) closeModal();
      }catch(err){
        console.error(err);
        toast("Hire failed", "Check permissions / Firestore rules.");
      }
    }

    $("applicantTable")?.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-action]");
      if(!btn) return;

      const action = btn.dataset.action;
      const id = btn.dataset.id;
      const col = btn.dataset.col;

      if(action === "view") viewApplication(id, col);
      if(action === "status"){
        const current = apps.find(x => x.id === id && x.collection === col)?.status || "Pending";
        const next = prompt("Set status to: Pending, Reviewed, Hired, Rejected", current);
        if(!next) return;
        const allowed = ["Pending","Reviewed","Hired","Rejected"];
        if(!allowed.includes(next)){
          toast("Invalid status", "Use: Pending, Reviewed, Hired, Rejected");
          return;
        }
        updateStatus(id, col, next);
      }
      if(action === "hire") hireEmployee(id, col);
    });

    ["search","statusFilter","jobFilter"].forEach(id => {
      const el = $(id);
      if(!el) return;
      el.addEventListener("input", renderApplicants);
      el.addEventListener("change", renderApplicants);
    });

    $("refreshBtn")?.addEventListener("click", () => {
      toast("Refreshing", "Reconnecting to live updates…");
      startSnapshots();
      startEmployeesSnapshot();
      startTimesheetsSnapshot();
    });

    $("exportBtn")?.addEventListener("click", () => {
      const rows = getFilteredApplicants().map(a => ({
        date: a.date,
        name: a.name,
        email: a.email,
        phone: a.phone,
        job: a.job,
        status: a.status,
        score: a.score,
        collection: a.collection,
        id: a.id
      }));
      downloadText(`applications-export-${new Date().toISOString().slice(0,10)}.csv`, toCSV(rows));
      toast("Exported", "CSV downloaded.");
      activateModule("applicants");
    });

    /* ==========
       Education Assignment
       ========== */
    let employees = [];

    function renderEmployeeSelect(){
      const sel = $("employeeSelect");
      if(!sel) return;

      const opts = employees.slice().sort((a,b) => (a.lastName||"").localeCompare(b.lastName||""));
      if(opts.length === 0){
        sel.innerHTML = `<option value="">No employees found</option>`;
        return;
      }

      sel.innerHTML = `<option value="">Select…</option>` + opts.map(e => {
        const id = e.employeeId || e.id;
        const name = `${e.firstName || ""} ${e.lastName || ""}`.trim() || "Employee";
        const role = e.role || "";
        return `<option value="${escapeHtml(String(id))}">${escapeHtml(`${name} (${id})${role ? " — " + role : ""}`)}</option>`;
      }).join("");
    }

    function startEmployeesSnapshot(){
      const qemp = query(collection(db, "employees"), orderBy("lastName", "asc"));
      const unsub = onSnapshot(qemp, (snap) => {
        const next = [];
        snap.forEach(d => next.push({ id: d.id, ...d.data() }));
        employees = next;
        renderEmployeeSelect();
        updateKPIs();
      }, (err) => {
        console.error(err);
        const sel = $("employeeSelect");
        if(sel) sel.innerHTML = `<option value="">Employees load error</option>`;
      });
      unsubscribers.push(unsub);
    }

    async function assignEducation(){
      const empId = $("employeeSelect").value;
      const training = ($("trainingInput").value || "").trim();
      const hint = $("assignHint");
      if(hint) hint.textContent = "";

      if(!empId){ toast("Select employee", "Choose an employee first."); return; }
      if(!training){ toast("Training required", "Enter a training name."); return; }

      try{
        const empRef = doc(db, "employees", empId);
        const empSnap = await getDoc(empRef);
        if(!empSnap.exists()){
          toast("Not found", "Employee record not found.");
          return;
        }
        const empData = empSnap.data() || {};
        const current = Array.isArray(empData.assignedEducation) ? empData.assignedEducation : [];
        const exists = current.some(x => (x?.name || "").toLowerCase() === training.toLowerCase());
        if(exists){ toast("Already assigned", "That training is already assigned to this employee."); return; }

        const entry = { name: training, status: "Assigned", assignedAtISO: new Date().toISOString() };

        await updateDoc(empRef, {
          assignedEducation: [...current, entry],
          educationUpdatedAt: serverTimestamp()
        });

        await addDoc(collection(db, "educationAssignments"), {
          employeeId: empId,
          trainingName: training,
          createdAt: serverTimestamp(),
          createdAtISO: new Date().toISOString(),
          status: "Assigned"
        });

        $("trainingInput").value = "";
        if(hint) hint.textContent = "Assigned!";
        toast("Assigned", `Education assigned to ${empId}.`);
      }catch(err){
        console.error(err);
        toast("Assign failed", "Check Firestore rules / permissions.");
      }
    }

    $("assignBtn")?.addEventListener("click", assignEducation);

    /* ==========
       Timesheet Review
       ========== */
    let timesheets = [];

    function getTimesheetStatus(t){ return (t.status || "Pending").toString(); }

    function renderTimesheets(){
      const tbody = $("timesheetTable");
      if(!tbody) return;

      const pending = timesheets
        .filter(t => getTimesheetStatus(t) !== "Approved")
        .sort((a,b) => (b.weekEndingISO || "").localeCompare(a.weekEndingISO || ""));

      if(pending.length === 0){
        tbody.innerHTML = `<tr><td colspan="6" class="muted">No pending timesheets.</td></tr>`;
        return;
      }

      tbody.innerHTML = "";
      for(const t of pending){
        const tr = document.createElement("tr");
        const status = getTimesheetStatus(t);
        const employeeLabel = t.employeeName || t.employeeId || "—";

        tr.innerHTML = `
          <td><strong>${escapeHtml(employeeLabel)}</strong><div class="muted" style="font-size:12px;">${escapeHtml(t.employeeId || "")}</div></td>
          <td>${escapeHtml(fmtDate(t.weekEndingISO || t.weekEnding || t.weekEndingDate))}</td>
          <td>${escapeHtml(String(t.hours ?? t.totalHours ?? "—"))}</td>
          <td>${escapeHtml(String(t.payCode ?? "REG"))}</td>
          <td><span class="status-pill ${escapeHtml(status)}">${escapeHtml(status)}</span></td>
          <td>
            <button class="btn btn-primary" data-ts-action="approve" data-id="${escapeHtml(t.id)}">Approve</button>
            <button class="btn btn-danger" data-ts-action="reject" data-id="${escapeHtml(t.id)}">Reject</button>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    function startTimesheetsSnapshot(){
      const qts = query(collection(db, "timesheets"), orderBy("weekEndingISO", "desc"));
      const unsub = onSnapshot(qts, (snap) => {
        const next = [];
        snap.forEach(d => next.push({ id: d.id, ...d.data() }));
        timesheets = next;
        renderTimesheets();
        updateKPIs();
      }, (err) => {
        console.error(err);
        toast("Timesheets error", "Could not load timesheets (check index / rules).");
      });
      unsubscribers.push(unsub);
    }

    async function updateTimesheetStatus(id, status){
      try{
        const ref = doc(db, "timesheets", id);
        const patch = {
          status,
          statusUpdatedAt: serverTimestamp(),
          statusUpdatedAtISO: new Date().toISOString()
        };
        if(status === "Approved"){
          patch.payrollReady = true;
          patch.payrollReadyAt = serverTimestamp();
          patch.payrollReadyAtISO = new Date().toISOString();
        }else{
          patch.payrollReady = false;
        }
        await updateDoc(ref, patch);
        toast("Updated", `Timesheet ${status}.`);
      }catch(err){
        console.error(err);
        toast("Update failed", "Check Firestore rules / permissions.");
      }
    }

    $("timesheetTable")?.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-ts-action]");
      if(!btn) return;
      const action = btn.dataset.tsAction;
      const id = btn.dataset.id;

      if(action === "approve") updateTimesheetStatus(id, "Approved");
      if(action === "reject"){
        if(!confirm("Reject this timesheet?")) return;
        updateTimesheetStatus(id, "Rejected");
      }
    });

    /* ==========
       KPIs
       ========== */
    function updateKPIs(){
      const applicantsCount = apps.length || 0;
      const employeesCount = employees.length || 0;
      const pendingTimesheets = timesheets.filter(t => getTimesheetStatus(t) !== "Approved").length || 0;

      if($("kpiApplicants")) $("kpiApplicants").textContent = applicantsCount;
      if($("kpiEmployees")) $("kpiEmployees").textContent = employeesCount;
      if($("kpiTimesheets")) $("kpiTimesheets").textContent = pendingTimesheets;
    }

    /* ==========
       Init
       ========== */
    startSnapshots();
    startEmployeesSnapshot();
    startTimesheetsSnapshot();
  </script>
</body>
</html>
