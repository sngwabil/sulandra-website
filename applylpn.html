<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LPN Application | Sulandra Community Living Services</title>
  <meta name="description" content="Licensed Practical Nurse (LPN) application with resume upload, license details, work history, references, and file uploads saved to Firebase." />

  <style>
    :root{
      --bg:#f6f7f8;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --border:#d1d5db;
      --brand:#1f5aa6;
      --focus:#2563eb;
      --danger:#b91c1c;
      --ok:#166534;
      --shadow: 0 6px 18px rgba(0,0,0,.08);
      --radius: 14px;

      --primary:#004b8d;
      --secondary:#0077c8;
      --accent:#d14124;
      --line:#e7eef8;

      --headerH:80px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--text); }
    a{ color:inherit; text-decoration:none; }
    img{ max-width:100%; display:block; }

    .alert-bar{
      background:var(--accent);
      color:#fff;
      text-align:center;
      padding:10px 20px;
      font-size:14px;
      font-weight:800;
    }

    header{
      position:sticky;
      top:0;
      z-index:1000;
      background:#fff;
      border-bottom:1px solid #ddd;
    }
    .top-nav{
      max-width:1200px;
      margin:0 auto;
      padding:15px 20px;
      height:var(--headerH);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    .logo{ display:flex; align-items:center; min-width:0; }
    .logo img{
      width:240px;
      height:auto;
      max-height:100%;
      object-fit:contain;
    }
    .sr-only{
      position:absolute;
      width:1px;height:1px;
      padding:0;margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }
    .header-tools{
      display:flex;
      gap:16px;
      align-items:center;
      font-size:14px;
      font-weight:700;
      white-space:nowrap;
    }
    .header-tools a{ color:var(--text); }
    .btn-cta{
      background:var(--primary);
      color:#fff !important;
      padding:10px 16px;
      border-radius:6px;
      font-weight:800;
    }

    .main-nav{
      background:#fff;
      border-top:1px solid #eee;
    }
    .nav-links{
      max-width:1200px;
      margin:0 auto;
      list-style:none;
      display:flex;
      gap:2px;
      padding:0 10px;
    }
    .nav-links a{
      display:block;
      padding:12px 14px;
      border-radius:10px;
      font-weight:800;
      color:#20446e;
    }
    .nav-links a:hover{ background:#f2f6ff; }
    .nav-links a.active{
      background:#eaf2ff;
      color:#1f5aa6;
      box-shadow: inset 0 0 0 1px #d7e6ff;
    }

    .wrap{ max-width: 1140px; margin:0 auto; padding:18px 16px; }
    main .grid{
      display:grid; grid-template-columns: 1.25fr .75fr; gap: 18px;
      align-items:start; margin-top: 18px;
    }
    @media (max-width: 920px){ main .grid{ grid-template-columns: 1fr; } }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 22px;
    }

    .card h2{ margin:0 0 4px; font-size: 18px; font-weight: 850; }
    .card p.sub{ margin:0 0 14px; color: var(--muted); font-size: 13px; }

    .section{ border-top: 1px dashed var(--border); padding-top: 16px; margin-top: 22px; }
    .section .minihead{ display:flex; align-items:baseline; justify-content:space-between; gap:10px; }
    .section .minihead small{ color: var(--muted); }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 680px){ .row{ grid-template-columns: 1fr; } }

    label{
      display:block; font-weight: 750; font-size: 12px; margin-bottom: 6px;
      color: var(--brand); text-transform: uppercase; letter-spacing: 0.5px;
    }
    .hint{ font-size: 12px; color: var(--muted); margin-top: 6px; }

    input[type="text"], input[type="email"], input[type="tel"],
    input[type="number"], input[type="date"], input[type="url"],
    input[type="password"],
    select, textarea{
      width:100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      font-size: 14px;
      background:#fff;
      outline: none;
    }
    textarea{ min-height: 92px; resize: vertical; }

    input:focus, select:focus, textarea:focus{
      border-color: var(--focus);
      box-shadow: 0 0 0 3px rgba(37,99,235,.15);
    }

    .checkboxline, .radioline{
      display:flex; gap:10px; align-items:flex-start;
      margin: 10px 0; font-size: 14px;
    }
    .checkboxline input, .radioline input{ transform: translateY(2px); }

    .btnrow{
      display:flex; gap: 12px; flex-wrap:wrap; margin-top: 18px;
      align-items:center;
    }
    button{
      border: 0; border-radius: 12px;
      padding: 14px 22px;
      font-weight: 850;
      cursor:pointer;
      font-size: 15px;
      transition: transform .05s ease, filter 0.2s ease, background 0.2s ease;
    }
    button:active{ transform: translateY(1px); }
    .primary{ background: var(--brand); color:#fff; }
    .primary:hover{ filter: brightness(0.95); }
    .ghost{
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }
    .ghost:hover{ background: #f9fafb; }
    .danger{
      background: #fee2e2;
      color: #7f1d1d;
      border: 1px solid #fecaca;
    }

    .side h3{
      margin: 0 0 10px; font-size: 12px;
      text-transform: uppercase; color: var(--brand);
      letter-spacing:.6px;
    }
    .kv{
      display:flex; justify-content:space-between; gap: 10px;
      padding: 10px 0; border-bottom: 1px solid rgba(209,213,219,.6);
      font-size: 13px;
    }
    .kv span:first-child{ color: var(--muted); font-weight: 650; }
    .kv span:last-child{ font-weight: 800; text-align: right; }

    .required::after{ content:" *"; color: var(--danger); font-weight:800; }

    .file-input-wrapper{ position: relative; overflow: hidden; display:block; width: 100%; }
    .file-input-wrapper input[type=file]{
      font-size: 100px; position:absolute; left:0; top:0;
      opacity:0; cursor:pointer; width:100%; height:100%;
    }
    .file-custom-btn{
      display:flex; justify-content:space-between; gap:12px; align-items:center;
      padding: 12px;
      border: 2px dashed var(--border);
      border-radius: 10px;
      color: var(--muted);
      font-weight: 650;
      background: #fafafa;
    }
    .file-input-wrapper:hover .file-custom-btn{ border-color: var(--brand); color: var(--brand); }
    .file-meta{ font-size: 12px; color: var(--muted); margin-top: 8px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px; border-radius: 999px;
      border: 1px solid var(--border); background:#fff;
      font-size: 12px; color: var(--muted); font-weight: 650;
      white-space:nowrap;
    }

    .filelist{
      margin-top:10px;
      border:1px solid rgba(209,213,219,.7);
      border-radius:12px;
      padding:10px;
      background:#fff;
    }
    .fileitem{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:8px 0;
      border-bottom:1px solid rgba(209,213,219,.55);
      font-size:13px;
    }
    .fileitem:last-child{ border-bottom:0; }
    .fileitem .meta{ color:var(--muted); font-weight:650; }
    .fileitem a{ color: var(--brand); text-decoration: underline; }

    .statusbar{
      display:none;
      margin-top: 14px;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: #fcfcfd;
    }
    .statusbar.show{ display:block; }
    .statusrow{ display:flex; justify-content:space-between; gap:10px; align-items:center; font-size: 13px; }
    .progress{
      height: 10px; border-radius: 999px; background: #eef2ff;
      border: 1px solid rgba(209,213,219,.7);
      overflow:hidden; margin-top: 10px;
    }
    .progress > div{
      height: 100%; width: 0%;
      background: linear-gradient(90deg, var(--brand), var(--focus));
      transition: width .25s ease;
    }

    .toast{
      position: fixed;
      right: 16px; bottom: 16px;
      width: min(420px, calc(100vw - 32px));
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 14px;
      display:none;
      z-index: 999;
    }
    .toast.show{ display:block; }
    .toast strong{ display:block; margin-bottom:4px; }
    .toast small{ color: var(--muted); }
    .toast .tbtns{ margin-top: 10px; display:flex; gap:10px; flex-wrap:wrap; }
    .toast .tbtns button{ padding:10px 14px; font-size: 13px; border-radius: 10px; }

    .error{
      margin-top: 8px;
      color: var(--danger);
      font-size: 12px;
      display:none;
    }
    .error.show{ display:block; }

    .ref-card, .exp-card{
      border: 1px solid rgba(209,213,219,.7);
      border-radius: 14px;
      padding: 14px;
      margin-top: 12px;
      background:#fff;
    }
    .ref-head, .exp-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
    }
    .ref-head strong, .exp-head strong{ font-size: 13px; }
    .ref-head button, .exp-head button{ padding: 8px 12px; font-size: 13px; border-radius: 10px; }

    .small{ font-size: 13px; color: var(--text); }
    .muted{ color: var(--muted); }

    /* Auth banner */
    #authCard{
      border:1px solid #e5e7eb;
      background:#fff;
      margin: 16px 0 0;
    }

    @media (max-width: 800px){
      :root{ --headerH:72px; }
      .alert-bar{ font-size:13px; padding:10px 12px; }
      .top-nav{ padding:12px 14px; gap:12px; }
      .logo img{ width:200px; }
      .header-tools{ gap:10px; }
      .header-tools a:not(.btn-cta){ display:none; }
      .nav-links{
        overflow-x:auto;
        -webkit-overflow-scrolling:touch;
        scrollbar-width:none;
      }
      .nav-links::-webkit-scrollbar{ display:none; }
      .nav-links a{ padding:14px 14px; }
    }
  </style>
</head>

<body>
  <div class="alert-bar">
    Sulandra Health is changing the way the world ages. Call us today for a free consultation.
  </div>

  <header>
    <div class="top-nav">
      <a href="/index.html" class="logo" aria-label="Sulandra Health Home">
        <img src="/assets/mainlogo.png" alt="Sulandra Health Logo" />
        <span class="sr-only">Sulandra Health</span>
      </a>

      <div class="header-tools">
        <a href="#">Reviews</a>
        <a href="#">Resources</a>
        <a href="#" class="btn-cta">Free Consultation</a>
      </div>
    </div>

    <nav class="main-nav" aria-label="Primary">
      <ul class="nav-links">
        <li><a href="/index.html">Home</a></li>
        <li><a href="/services.html">Services</a></li>
        <li><a class="active" href="/Careers.html">Careers</a></li>
        <li><a href="#">About Us</a></li>
        <li><a href="#">Contact</a></li>
      </ul>
    </nav>
  </header>

  <main class="wrap" role="main">
    <div class="grid">
      <section class="card" aria-label="LPN application form">
        <h2>Application for: Licensed Practical Nurse (LPN)</h2>
        <p class="sub">You must sign in with your email address before you can fill out and submit this application.</p>

        <!-- =========================
             SIGN IN / CREATE ACCOUNT
             ========================= -->
        <div class="card" id="authCard">
          <h2 style="margin:0 0 6px;">Sign in to apply</h2>
          <p class="sub" style="margin:0 0 14px;">Use your email address to sign in. If you don’t have an account, create one.</p>

          <div class="row">
            <div>
              <label class="required" for="loginEmail">Email</label>
              <input id="loginEmail" type="email" autocomplete="email" placeholder="you@example.com" />
              <div class="error" id="err-loginEmail">Enter a valid email.</div>
            </div>
            <div>
              <label class="required" for="loginPassword">Password</label>
              <input id="loginPassword" type="password" autocomplete="current-password" placeholder="Password (6+ characters)" />
              <div class="error" id="err-loginPassword">Password is required (6+ characters).</div>
            </div>
          </div>

          <div class="btnrow" style="margin-top:14px;">
            <button type="button" class="primary" id="loginBtn">Sign In</button>
            <button type="button" class="ghost" id="signupBtn">Create Account</button>
            <button type="button" class="ghost" id="resetPwBtn">Forgot Password</button>
            <button type="button" class="ghost" id="logoutBtn" style="display:none;">Sign Out</button>
            <span class="pill" id="authStatusPill">Checking sign-in…</span>
          </div>

          <p class="hint" style="margin-top:10px;">
            Tip: Creating an account lets you return later and continue your draft.
          </p>
        </div>

        <form id="appForm" method="post" action="#" enctype="multipart/form-data" novalidate>
          <input type="hidden" name="jobTitle" value="Licensed Practical Nurse (LPN)" />
          <input type="hidden" name="company" value="Sulandra Community Living Services" />
          <input type="hidden" name="version" value="2.0" />

          <div class="section" style="border-top:none; padding-top:0; margin-top:0;">
            <div class="minihead">
              <h2>Basic Information</h2>
              <small>Step 1</small>
            </div>

            <div class="row">
              <div>
                <label class="required" for="firstName">First name</label>
                <input id="firstName" name="firstName" type="text" autocomplete="given-name" required />
                <div class="error" id="err-firstName">Please enter your first name.</div>
              </div>
              <div>
                <label class="required" for="lastName">Last name</label>
                <input id="lastName" name="lastName" type="text" autocomplete="family-name" required />
                <div class="error" id="err-lastName">Please enter your last name.</div>
              </div>
            </div>

            <div class="row" style="margin-top:16px;">
              <div>
                <label class="required" for="email">Email (locked to signed-in email)</label>
                <input id="email" name="email" type="email" autocomplete="email" required disabled />
                <div class="error" id="err-email">Please enter a valid email.</div>
              </div>
              <div>
                <label class="required" for="phone">Phone</label>
                <input id="phone" name="phone" type="tel" autocomplete="tel" placeholder="(555) 555-5555" required />
                <div class="error" id="err-phone">Please enter a valid phone number.</div>
              </div>
            </div>

            <div class="row" style="margin-top:16px;">
              <div>
                <label class="required" for="address1">Address</label>
                <input id="address1" name="address1" type="text" autocomplete="address-line1" required />
                <div class="error" id="err-address1">Please enter your address.</div>
              </div>
              <div>
                <label for="address2">Apt / Unit</label>
                <input id="address2" name="address2" type="text" autocomplete="address-line2" />
              </div>
            </div>

            <div class="row" style="margin-top:16px;">
              <div>
                <label class="required" for="city">City</label>
                <input id="city" name="city" type="text" autocomplete="address-level2" required />
                <div class="error" id="err-city">Please enter your city.</div>
              </div>
              <div>
                <label class="required" for="state">State</label>
                <select id="state" name="state" autocomplete="address-level1" required>
                  <option value="">Select…</option>
                  <option>AL</option><option>AK</option><option>AZ</option><option>AR</option><option>CA</option><option>CO</option>
                  <option>CT</option><option>DE</option><option>FL</option><option>GA</option><option>HI</option><option>ID</option>
                  <option>IL</option><option>IN</option><option>IA</option><option>KS</option><option>KY</option><option>LA</option>
                  <option>ME</option><option>MD</option><option>MA</option><option>MI</option><option>MN</option><option>MS</option>
                  <option>MO</option><option>MT</option><option>NE</option><option>NV</option><option>NH</option><option>NJ</option>
                  <option>NM</option><option>NY</option><option>NC</option><option>ND</option><option>OH</option><option>OK</option>
                  <option>OR</option><option>PA</option><option>RI</option><option>SC</option><option>SD</option><option>TN</option>
                  <option>TX</option><option>UT</option><option>VT</option><option>VA</option><option>WA</option><option>WV</option>
                  <option>WI</option><option>WY</option>
                </select>
                <div class="error" id="err-state">Please select your state.</div>
              </div>
            </div>

            <div class="row" style="margin-top:16px;">
              <div>
                <label class="required" for="zip">ZIP</label>
                <input id="zip" name="zip" type="text" inputmode="numeric" autocomplete="postal-code" required />
                <div class="error" id="err-zip">Please enter a valid ZIP code.</div>
              </div>
              <div>
                <label class="required" for="startDate">Earliest start date</label>
                <input id="startDate" name="startDate" type="date" required />
                <div class="error" id="err-startDate">Please select a start date.</div>
              </div>
            </div>
          </div>

          <!-- ======= the rest of your form remains unchanged below ======= -->

          <div class="section">
            <div class="minihead">
              <h2>License & Credentials</h2>
              <small>Step 2</small>
            </div>
            <p class="sub">Provide your LPN license details and current certifications.</p>

            <div class="row">
              <div>
                <label class="required" for="lpnLicenseNumber">LPN license number</label>
                <input id="lpnLicenseNumber" name="lpnLicenseNumber" type="text" required />
                <div class="error" id="err-lpnLicenseNumber">License number is required.</div>
              </div>
              <div>
                <label class="required" for="lpnLicenseState">Issuing state</label>
                <select id="lpnLicenseState" name="lpnLicenseState" required>
                  <option value="">Select…</option>
                  <option>AL</option><option>AK</option><option>AZ</option><option>AR</option><option>CA</option><option>CO</option>
                  <option>CT</option><option>DE</option><option>FL</option><option>GA</option><option>HI</option><option>ID</option>
                  <option>IL</option><option>IN</option><option>IA</option><option>KS</option><option>KY</option><option>LA</option>
                  <option>ME</option><option>MD</option><option>MA</option><option>MI</option><option>MN</option><option>MS</option>
                  <option>MO</option><option>MT</option><option>NE</option><option>NV</option><option>NH</option><option>NJ</option>
                  <option>NM</option><option>NY</option><option>NC</option><option>ND</option><option>OH</option><option>OK</option>
                  <option>OR</option><option>PA</option><option>RI</option><option>SC</option><option>SD</option><option>TN</option>
                  <option>TX</option><option>UT</option><option>VT</option><option>VA</option><option>WA</option><option>WV</option>
                  <option>WI</option><option>WY</option>
                </select>
                <div class="error" id="err-lpnLicenseState">Issuing state is required.</div>
              </div>
            </div>

            <div class="row" style="margin-top:16px;">
              <div>
                <label class="required" for="lpnLicenseExp">License expiration date</label>
                <input id="lpnLicenseExp" name="lpnLicenseExp" type="date" required />
                <div class="error" id="err-lpnLicenseExp">Expiration date is required.</div>
              </div>
              <div>
                <label for="npi">NPI number (optional)</label>
                <input id="npi" name="npi" type="text" />
              </div>
            </div>

            <div style="margin-top:16px;">
              <label class="required">Current certifications (select all that apply)</label>
              <div class="checkboxline"><input type="checkbox" name="certs" value="BLS" /> <span>BLS (Basic Life Support)</span></div>
              <div class="checkboxline"><input type="checkbox" name="certs" value="CPR" /> <span>CPR</span></div>
              <div class="checkboxline"><input type="checkbox" name="certs" value="First Aid" /> <span>First Aid</span></div>
              <div class="checkboxline"><input type="checkbox" name="certs" value="IV Therapy" /> <span>IV Therapy / IV Certification</span></div>
              <div class="checkboxline"><input type="checkbox" name="certs" value="Other" /> <span>Other</span></div>
              <div class="checkboxline"><input type="checkbox" id="cert_none" name="cert_none" value="none" /> <span><strong>No current certifications</strong></span></div>
              <div class="error" id="err-certs">Please select at least one option (or select “No current certifications”).</div>
            </div>

            <div style="margin-top:16px;">
              <label for="skills">Clinical skills / specialties (optional)</label>
              <textarea id="skills" name="skills" placeholder="e.g., wound care, medication administration, vitals, charting, geriatrics, pediatrics, behavioral health, etc."></textarea>
            </div>
          </div>

          <!-- (Everything else below is your original form unchanged) -->
          <!-- ... keep all remaining sections as-is ... -->

          <div class="section">
            <div class="minihead">
              <h2>Agreement & Signature</h2>
              <small>Step 9</small>
            </div>

            <div class="checkboxline">
              <input id="consentTruth" name="consentTruth" type="checkbox" required />
              <label for="consentTruth" style="display:inline; color:var(--text); font-weight:550; text-transform:none; letter-spacing:0;">
                I certify that the information provided is true and complete to the best of my knowledge.
              </label>
            </div>
            <div class="error" id="err-consentTruth">This acknowledgement is required.</div>

            <div class="checkboxline">
              <input id="consentESign" name="consentESign" type="checkbox" required />
              <label for="consentESign" style="display:inline; color:var(--text); font-weight:550; text-transform:none; letter-spacing:0;">
                I agree that typing my name below serves as my electronic signature.
              </label>
            </div>
            <div class="error" id="err-consentESign">E-sign consent is required.</div>

            <div class="row" style="margin-top:12px;">
              <div>
                <label class="required" for="signature">Electronic signature (type full name)</label>
                <input id="signature" name="signature" type="text" required />
                <div class="error" id="err-signature">Please type your full name as signature.</div>
              </div>
              <div>
                <label class="required" for="signatureDate">Signature date</label>
                <input id="signatureDate" name="signatureDate" type="date" required />
                <div class="error" id="err-signatureDate">Please select a date.</div>
              </div>
            </div>

            <div class="btnrow">
              <button type="submit" class="primary" id="submitBtn">Submit Application</button>
              <button type="button" class="ghost" id="saveBtn">Save & Continue Later</button>
              <button type="button" class="ghost" id="previewBtn">Preview</button>
              <button type="button" class="danger" id="resetBtn">Clear Form</button>
              <span class="pill" id="autosavePill" title="Autosave status">Autosave: off</span>
            </div>

            <div class="statusbar" id="statusbar" aria-live="polite">
              <div class="statusrow">
                <strong id="statusTitle">Submitting…</strong>
                <span class="muted" id="statusHint">Please don’t close this tab.</span>
              </div>
              <div class="progress" aria-label="Submission progress">
                <div id="progressFill"></div>
              </div>
            </div>
          </div>
        </form>
      </section>

      <aside class="side" aria-label="Job overview">
        <div class="card">
          <h3>Position Summary</h3>
          <div class="kv"><span>Role:</span><span>Licensed Practical Nurse (LPN)</span></div>
          <div class="kv"><span>Location:</span><span>Home & Community Based</span></div>
          <div class="kv"><span>Department:</span><span>Clinical Services</span></div>
          <div class="kv"><span>Type:</span><span>Full-Time / Part-Time / PRN</span></div>

          <div style="margin-top:16px;">
            <h3>Core Responsibilities</h3>
            <p class="small">
              • Provide direct nursing care within scope (vitals, meds, documentation).<br>
              • Support clinical plans and report changes in condition.<br>
              • Collaborate with RNs/lead staff and follow agency protocols.<br>
              • Maintain accurate records and uphold confidentiality.
            </p>
          </div>
        </div>

        <div class="card" style="margin-top:18px;">
          <h3>Progress</h3>
          <div class="kv"><span>Required fields complete:</span><span id="reqCount">0%</span></div>
          <div class="kv"><span>Resume selected:</span><span id="resumeStatus">No</span></div>
          <div class="kv"><span>Draft saved:</span><span id="draftStatus">No</span></div>
          <div class="kv"><span>References:</span><span id="refsStatus">0/2</span></div>
          <div class="kv"><span>Work experience:</span><span id="expStatus">0</span></div>
          <div class="kv"><span>Files selected:</span><span id="filesStatus">0</span></div>
          <div class="hint">Draft saves to your browser (localStorage). Files must be re-attached after reload.</div>
        </div>
      </aside>
    </div>
  </main>

  <div class="toast" id="toast" role="status" aria-live="polite">
    <strong id="toastTitle">Saved</strong>
    <small id="toastBody">Your draft has been saved on this device.</small>
    <div class="tbtns">
      <button class="ghost" id="toastCloseBtn" type="button">Close</button>
      <button class="primary" id="toastDownloadBtn" type="button">Download copy (JSON)</button>
    </div>
  </div>

  <script type="module">
    /* ==========================================================
       Firebase (Firestore + Storage + Auth) + Login-gated submission
       ========================================================== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      sendPasswordResetEmail,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCi3Qtyka_PJsHT9Ln7LJZp2BCqOxW3lM8",
      authDomain: "sulandra-health-portal.firebaseapp.com",
      projectId: "sulandra-health-portal",
      storageBucket: "sulandra-health-portal.firebasestorage.app",
      messagingSenderId: "547316167712",
      appId: "1:547316167712:web:24dfc2c5bd9d0296b4f845",
      measurementId: "G-N2M4L7YMNB"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    /* ==========
       Utilities
       ========== */
    const $ = (id) => document.getElementById(id);

    const DRAFT_KEY = "scls_apply_lpn_v2_draft";
    const MAX_FILE_MB = 10;
    const MAX_FILE_BYTES = MAX_FILE_MB * 1024 * 1024;

    function show(el, on=true){ el.classList.toggle("show", !!on); }
    function setText(el, t){ el.textContent = t; }
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function toast(title, body){
      setText($("toastTitle"), title);
      setText($("toastBody"), body || "");
      show($("toast"), true);
    }
    $("toastCloseBtn").addEventListener("click", () => show($("toast"), false));

    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function bytesToHuman(bytes){
      const u = ["B","KB","MB","GB"];
      let i = 0, n = Number(bytes||0);
      while(n >= 1024 && i < u.length-1){ n/=1024; i++; }
      return `${n.toFixed(n<10 && i>0 ? 1 : 0)} ${u[i]}`;
    }

    function isEmail(v){
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(v || "").trim());
    }
    function isPhone(v){
      const s = String(v || "").replace(/[^\d]/g, "");
      return s.length >= 10;
    }
    function isZip(v){
      return /^\d{5}(-\d{4})?$/.test(String(v||"").trim());
    }
    function fileOk(file){
      if (!file) return true;
      return file.size <= MAX_FILE_BYTES;
    }
    function hasAnyChecked(name){
      return Array.from(document.querySelectorAll(`input[name="${CSS.escape(name)}"]`)).some(i => i.checked);
    }
    function getChecked(name){
      return Array.from(document.querySelectorAll(`input[name="${CSS.escape(name)}"]:checked`)).map(i => i.value);
    }

    /* ==========================
       AUTH: lock the form until signed in
       ========================== */
    function setFormEnabled(enabled){
      const form = $("appForm");
      const elements = form.querySelectorAll("input, select, textarea, button");
      elements.forEach(el => {
        // keep hidden inputs always enabled
        if (el.type === "hidden") return;
        el.disabled = !enabled;
      });

      // email stays locked when enabled too (must match auth email)
      if (enabled) $("email").disabled = true;
    }

    function setAuthUI(user){
      if (!user){
        $("authStatusPill").textContent = "Not signed in";
        $("logoutBtn").style.display = "none";
        setFormEnabled(false);

        // keep the email field blank when signed out
        $("email").value = "";
        return;
      }

      $("authStatusPill").textContent = `Signed in: ${user.email || user.uid}`;
      $("logoutBtn").style.display = "inline-flex";

      setFormEnabled(true);
      $("email").value = user.email || "";
      $("email").disabled = true;
    }

    function validLoginEmail(){
      const em = $("loginEmail").value.trim();
      const ok = isEmail(em);
      $("err-loginEmail").classList.toggle("show", !ok);
      return ok ? em : null;
    }
    function validLoginPassword(){
      const pw = $("loginPassword").value || "";
      const ok = pw.length >= 6;
      $("err-loginPassword").classList.toggle("show", !ok);
      return ok ? pw : null;
    }

    $("loginBtn").addEventListener("click", async () => {
      const em = validLoginEmail();
      const pw = validLoginPassword();
      if (!em || !pw) return;

      try{
        await signInWithEmailAndPassword(auth, em, pw);
        toast("Signed in", "You can now complete and submit the application.");
      }catch(err){
        console.error(err);
        toast("Sign-in failed", err?.message || "Please try again.");
      }
    });

    $("signupBtn").addEventListener("click", async () => {
      const em = validLoginEmail();
      const pw = validLoginPassword();
      if (!em || !pw){
        toast("Create account", "Enter email + password (6+ chars), then click Create Account.");
        return;
      }

      try{
        await createUserWithEmailAndPassword(auth, em, pw);
        toast("Account created", "You're signed in. You can now apply.");
      }catch(err){
        console.error(err);
        toast("Sign-up failed", err?.message || "Please try again.");
      }
    });

    $("resetPwBtn").addEventListener("click", async () => {
      const em = validLoginEmail();
      if (!em) return;

      try{
        await sendPasswordResetEmail(auth, em);
        toast("Password reset sent", "Check your email for a reset link.");
      }catch(err){
        console.error(err);
        toast("Reset failed", err?.message || "Please try again.");
      }
    });

    $("logoutBtn").addEventListener("click", async () => {
      try{
        await signOut(auth);
        toast("Signed out", "Please sign in again to apply.");
      }catch(err){
        console.error(err);
        toast("Sign-out failed", err?.message || "Please try again.");
      }
    });

    /* ==========
       Status bar
       ========== */
    function setSubmitting(on){
      // Only disable form buttons (auth buttons remain usable)
      $("submitBtn").disabled = on;
      $("saveBtn").disabled = on;
      $("previewBtn").disabled = on;
      $("resetBtn").disabled = on;
      show($("statusbar"), on);
    }
    function setProgress(pct, title, hint){
      $("progressFill").style.width = `${clamp(pct,0,100)}%`;
      if(title) setText($("statusTitle"), title);
      if(hint) setText($("statusHint"), hint);
    }

    /* ==========
       Dynamic Work Experience
       ========== */
    let expCount = 0;

    function makeExpCard(data = {}){
      expCount += 1;
      const idx = expCount;

      const wrap = document.createElement("div");
      wrap.className = "exp-card";
      wrap.dataset.exp = String(idx);

      wrap.innerHTML = `
        <div class="exp-head">
          <strong>Work Experience #${idx}</strong>
          <button type="button" class="danger" aria-label="Remove experience">Remove</button>
        </div>

        <div class="row">
          <div>
            <label class="required" for="exp_employer_${idx}">Employer</label>
            <input id="exp_employer_${idx}" name="exp_employer_${idx}" type="text" required value="${escapeHtml(data.employer || "")}">
            <div class="error" id="err-exp_employer_${idx}">Employer is required.</div>
          </div>
          <div>
            <label class="required" for="exp_title_${idx}">Job title</label>
            <input id="exp_title_${idx}" name="exp_title_${idx}" type="text" required value="${escapeHtml(data.title || "")}">
            <div class="error" id="err-exp_title_${idx}">Job title is required.</div>
          </div>
        </div>

        <div class="row" style="margin-top:16px;">
          <div>
            <label class="required" for="exp_start_${idx}">Start date</label>
            <input id="exp_start_${idx}" name="exp_start_${idx}" type="date" required value="${escapeHtml(data.start || "")}">
            <div class="error" id="err-exp_start_${idx}">Start date is required.</div>
          </div>
          <div>
            <label class="required" for="exp_end_${idx}">End date</label>
            <input id="exp_end_${idx}" name="exp_end_${idx}" type="date" required value="${escapeHtml(data.end || "")}">
            <div class="error" id="err-exp_end_${idx}">End date is required.</div>
          </div>
        </div>

        <div style="margin-top:16px;">
          <label class="required" for="exp_reason_${idx}">Reason for leaving</label>
          <textarea id="exp_reason_${idx}" name="exp_reason_${idx}" required placeholder="Brief explanation">${escapeHtml(data.reason || "")}</textarea>
          <div class="error" id="err-exp_reason_${idx}">Reason for leaving is required.</div>
        </div>

        <div class="row" style="margin-top:16px;">
          <div>
            <label for="exp_supervisorPhone_${idx}">Supervisor/HR phone (optional)</label>
            <input id="exp_supervisorPhone_${idx}" name="exp_supervisorPhone_${idx}" type="tel" placeholder="(555) 555-5555" value="${escapeHtml(data.supervisorPhone || "")}">
          </div>
          <div>
            <label class="required" for="exp_contactOk_${idx}">Consent to contact?</label>
            <select id="exp_contactOk_${idx}" name="exp_contactOk_${idx}" required>
              <option value="">Select…</option>
              <option value="yes" ${data.contactOk === "yes" ? "selected" : ""}>Yes</option>
              <option value="no" ${data.contactOk === "no" ? "selected" : ""}>No</option>
            </select>
            <div class="error" id="err-exp_contactOk_${idx}">Please select an option.</div>
          </div>
        </div>
      `;

      wrap.querySelector("button.danger").addEventListener("click", () => {
        wrap.remove();
        updateProgress();
        scheduleAutosave(true);
      });

      wrap.addEventListener("input", () => { scheduleAutosave(); updateProgress(); });
      wrap.addEventListener("change", () => { scheduleAutosave(); updateProgress(); });

      return wrap;
    }

    // If your page includes addExpBtn (it does in your original),
    // keep these handlers even if the section is below in your file.
    const addExpBtn = $("addExpBtn");
    if (addExpBtn){
      addExpBtn.addEventListener("click", () => {
        $("expContainer").appendChild(makeExpCard());
        updateProgress();
        scheduleAutosave(true);
      });
    }

    /* ==========
       Dynamic References
       ========== */
    let refCount = 0;

    function makeRefCard(data = {}){
      refCount += 1;
      const idx = refCount;

      const wrap = document.createElement("div");
      wrap.className = "ref-card";
      wrap.dataset.ref = String(idx);

      wrap.innerHTML = `
        <div class="ref-head">
          <strong>Reference #${idx}</strong>
          <button type="button" class="danger" aria-label="Remove reference">Remove</button>
        </div>

        <div class="row">
          <div>
            <label class="required" for="ref_name_${idx}">Name</label>
            <input id="ref_name_${idx}" name="ref_name_${idx}" type="text" required value="${escapeHtml(data.name || "")}">
            <div class="error" id="err-ref_name_${idx}">Name is required.</div>
          </div>
          <div>
            <label class="required" for="ref_relation_${idx}">Relationship</label>
            <input id="ref_relation_${idx}" name="ref_relation_${idx}" type="text" required value="${escapeHtml(data.relation || "")}">
            <div class="error" id="err-ref_relation_${idx}">Relationship is required.</div>
          </div>
        </div>

        <div class="row" style="margin-top:16px;">
          <div>
            <label class="required" for="ref_phone_${idx}">Phone</label>
            <input id="ref_phone_${idx}" name="ref_phone_${idx}" type="tel" placeholder="(555) 555-5555" required value="${escapeHtml(data.phone || "")}">
            <div class="error" id="err-ref_phone_${idx}">Valid phone is required.</div>
          </div>
          <div>
            <label class="required" for="ref_email_${idx}">Email</label>
            <input id="ref_email_${idx}" name="ref_email_${idx}" type="email" required value="${escapeHtml(data.email || "")}">
            <div class="error" id="err-ref_email_${idx}">Valid email is required.</div>
          </div>
        </div>
      `;

      wrap.querySelector("button.danger").addEventListener("click", () => {
        wrap.remove();
        updateProgress();
        scheduleAutosave(true);
      });

      wrap.addEventListener("input", () => { scheduleAutosave(); updateProgress(); });
      wrap.addEventListener("change", () => { scheduleAutosave(); updateProgress(); });

      return wrap;
    }

    const addRefBtn = $("addRefBtn");
    if (addRefBtn){
      addRefBtn.addEventListener("click", () => {
        $("refsContainer").appendChild(makeRefCard());
        updateProgress();
        scheduleAutosave(true);
      });
    }

    /* ==========
       File UI
       ========== */
    function renderSelectedFileList(listEl, files){
      if(!listEl) return;
      if(!files || files.length === 0){
        listEl.style.display = "none";
        listEl.innerHTML = "";
        return;
      }
      listEl.style.display = "block";
      listEl.innerHTML = "";
      Array.from(files).forEach(f => {
        const row = document.createElement("div");
        row.className = "fileitem";
        row.innerHTML = `
          <div>
            <div style="font-weight:800;">${escapeHtml(f.name)}</div>
            <div class="meta">${escapeHtml(f.type || "unknown")} • ${bytesToHuman(f.size)}</div>
          </div>
          <div class="meta">Selected</div>
        `;
        listEl.appendChild(row);
      });
    }

    function updateFileWidget(inputId, chosenId, pillId, listId, emptyLabel, emptyPill){
      const input = $(inputId);
      if(!input) return;
      const files = input.files ? Array.from(input.files) : [];

      if(files.length === 0){
        if($(chosenId)) setText($(chosenId), emptyLabel);
        if($(pillId)) setText($(pillId), emptyPill);
      }else if(files.length === 1){
        if($(chosenId)) setText($(chosenId), files[0].name);
        if($(pillId)) setText($(pillId), bytesToHuman(files[0].size));
      }else{
        if($(chosenId)) setText($(chosenId), `${files.length} files selected`);
        if($(pillId)) setText($(pillId), `${files.length} files`);
      }

      renderSelectedFileList($(listId), files);
      updateProgress();
      scheduleAutosave(true);
    }

    if ($("resume")) $("resume").addEventListener("change", () => updateFileWidget("resume","resume-chosen","resume-pill","resume-list","Click to choose resume…","No file"));
    if ($("coverLetter")) $("coverLetter").addEventListener("change", () => updateFileWidget("coverLetter","cover-chosen","cover-pill","cover-list","Click to choose cover letter…","Optional"));
    if ($("licenseDoc")) $("licenseDoc").addEventListener("change", () => updateFileWidget("licenseDoc","license-chosen","license-pill","license-list","Click to choose documents…","Optional"));

    function countSelectedFiles(){
      const a = $("resume")?.files?.length || 0;
      const b = $("coverLetter")?.files?.length || 0;
      const c = $("licenseDoc")?.files?.length || 0;
      return a + b + c;
    }

    /* ==========
       Cert none logic
       ========== */
    if ($("cert_none")){
      $("cert_none").addEventListener("change", (e) => {
        if (e.target.checked){
          document.querySelectorAll('input[name="certs"]').forEach(cb => cb.checked = false);
        }
        scheduleAutosave(true);
        updateProgress();
      });
    }

    document.querySelectorAll('input[name="certs"]').forEach(cb => {
      cb.addEventListener("change", () => {
        if (cb.checked && $("cert_none")) $("cert_none").checked = false;
        scheduleAutosave();
        updateProgress();
      });
    });

    /* ==========
       Validation helpers (unchanged, expects your full form ids)
       ========== */
    function setErr(id, on){
      const el = $(id);
      if (!el) return;
      el.classList.toggle("show", !!on);
    }

    function validateBasics(){
      let ok = true;

      const fn = $("firstName").value.trim();
      const ln = $("lastName").value.trim();
      const em = $("email").value.trim();
      const ph = $("phone").value.trim();
      const a1 = $("address1").value.trim();
      const city = $("city").value.trim();
      const st = $("state").value;
      const zip = $("zip").value.trim();
      const start = $("startDate").value;

      setErr("err-firstName", !fn); ok = ok && !!fn;
      setErr("err-lastName", !ln); ok = ok && !!ln;

      setErr("err-email", !isEmail(em)); ok = ok && isEmail(em);
      setErr("err-phone", !isPhone(ph)); ok = ok && isPhone(ph);

      setErr("err-address1", !a1); ok = ok && !!a1;
      setErr("err-city", !city); ok = ok && !!city;
      setErr("err-state", !st); ok = ok && !!st;
      setErr("err-zip", !isZip(zip)); ok = ok && isZip(zip);

      setErr("err-startDate", !start); ok = ok && !!start;

      return ok;
    }

    // NOTE: keep all your other validate* functions exactly as you had them.
    // To keep this rewrite focused on login-gating, I’m not duplicating every single one again.
    // If you paste your full original form sections below (steps 3-8), those functions will work as before.
    //
    // If you want, reply "paste the rest too" and I’ll output a single uninterrupted HTML with EVERYTHING included.

    /* ==========
       Draft save/restore + Progress sidebar
       (keep your existing code here unchanged)
       ========== */
    // --- For brevity, this rewrite assumes you keep your existing:
    // collectDraft(), applyDraft(), scheduleAutosave(), updateProgress(), etc.
    // If you want a single-file copy with *all* of it included, say “include all functions”.

    /* ==========
       Upload helpers
       ========== */
    function safeName(name){
      return String(name || "file").replace(/[^a-zA-Z0-9._-]+/g, "_").slice(0, 140);
    }

    async function uploadOneFile(file, path, onProgress){
      return await new Promise((resolve, reject) => {
        const storageRef = sRef(storage, path);
        const task = uploadBytesResumable(storageRef, file, { contentType: file.type || "application/octet-stream" });

        task.on("state_changed", (snap) => {
          const pct = snap.totalBytes ? (snap.bytesTransferred / snap.totalBytes) * 100 : 0;
          onProgress?.(pct);
        }, reject, async () => {
          try{
            const url = await getDownloadURL(task.snapshot.ref);
            resolve({ name: file.name, type: file.type || "unknown", size: file.size, path, url });
          }catch(err){ reject(err); }
        });
      });
    }

    /* ==========
       Submission (Firestore + Storage) with Auth required
       ========== */
    async function submitToFirebase(){
      const user = auth.currentUser;
      if (!user) throw new Error("You must sign in before submitting your application.");

      setSubmitting(true);
      setProgress(5, "Submitting…", "Validating files…");

      const resume = $("resume")?.files?.[0] || null;
      const cover = $("coverLetter")?.files?.[0] || null;
      const licenseFiles = $("licenseDoc")?.files ? Array.from($("licenseDoc").files) : [];

      if(!resume){
        setErr("err-resume", true);
        throw new Error("Resume is required.");
      }
      if(!fileOk(resume) || (cover && !fileOk(cover)) || licenseFiles.some(f => !fileOk(f))){
        throw new Error(`One or more files exceed ${MAX_FILE_MB}MB.`);
      }

      // You already have collectDraft() in your original file.
      const draft = collectDraft(true);

      setProgress(10, "Submitting…", "Creating application record…");
      const baseDoc = {
        jobTitle: "Licensed Practical Nurse (LPN)",
        company: "Sulandra Community Living Services",
        version: "2.0",
        status: "Pending",                 // ✅ matches admin.html statuses
        createdAt: serverTimestamp(),
        submittedAtISO: new Date().toISOString(),

        applicantUid: user.uid,
        applicantEmail: user.email || "",

        fields: draft.fields,
        cert_none: draft.cert_none,
        certs: draft.certs,
        days: draft.days,
        screening: draft.screening,
        experiences: draft.experiences,
        references: draft.references,
        files: []
      };

      const docRef = await addDoc(collection(db, "applications_lpn"), baseDoc);
      const appId = docRef.id;

      const uploaded = [];
      const all = [
        { key:"resume", file: resume, bucket:"resume" },
        { key:"coverLetter", file: cover, bucket:"cover-letter" },
        ...licenseFiles.map((f, i) => ({ key:`licenseDoc_${i+1}`, file:f, bucket:"license-docs" }))
      ].filter(x => !!x.file);

      let fileIndex = 0;
      const startPct = 15;
      const endPct = 90;

      for(const item of all){
        fileIndex++;
        const pctBase = startPct + ((fileIndex - 1) / all.length) * (endPct - startPct);
        const pctSpan = (endPct - startPct) / all.length;

        const path = `applications_lpn/${appId}/${item.bucket}/${Date.now()}_${safeName(item.file.name)}`;

        setProgress(pctBase, "Uploading files…", `${fileIndex}/${all.length}: ${item.file.name}`);

        const meta = await uploadOneFile(item.file, path, (p) => {
          setProgress(pctBase + (p/100)*pctSpan, "Uploading files…", `${fileIndex}/${all.length}: ${item.file.name}`);
        });

        uploaded.push({ ...meta, field: item.key });
      }

      setProgress(92, "Finalizing…", "Saving uploaded file links…");
      await addDoc(collection(db, "applications_lpn_submissions"), {
        applicationId: appId,
        applicantUid: user.uid,
        applicantEmail: user.email || "",
        createdAt: serverTimestamp(),
        submittedAtISO: new Date().toISOString(),
        uploadedFiles: uploaded
      });

      setProgress(100, "Submitted!", "Thank you — we received your application.");
      return { appId, uploaded };
    }

    /* ==========
       Form submit (unchanged idea, but auth enforced by submitToFirebase)
       ========== */
    $("appForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      setErr("err-resume", false);

      if (!auth.currentUser){
        toast("Sign in required", "Please sign in before submitting.");
        return;
      }

      const ok = validateAll();
      if (!ok){
        toast("Please fix errors", "Some required fields are missing or invalid.");
        const first = document.querySelector(".error.show");
        if (first) first.scrollIntoView({behavior:"smooth", block:"center"});
        return;
      }

      try{
        const { appId, uploaded } = await submitToFirebase();
        renderUploadedFiles(uploaded);

        localStorage.removeItem(DRAFT_KEY);
        if ($("draftStatus")) setText($("draftStatus"), "No");
        setText($("autosavePill"), "Autosave: off");

        toast("Submitted", `Application received. Confirmation ID: ${appId}`);
      } catch(err){
        console.error(err);
        setSubmitting(false);
        setProgress(0, "Submission error", "Please try again.");
        toast("Submission error", err?.message || "Please check your internet and try again.");
      } finally {
        setSubmitting(false);
      }
    });

    /* ==========
       Init
       ========== */
    (function init(){
      // lock form until auth state known
      setFormEnabled(false);

      onAuthStateChanged(auth, (user) => {
        setAuthUI(user);
        // your updateProgress() exists in original
        try{ updateProgress(); }catch(_){}
      });

      // default signature date = today
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth()+1).padStart(2,'0');
      const dd = String(today.getDate()).padStart(2,'0');
      if($("signatureDate") && !$("signatureDate").value) $("signatureDate").value = `${yyyy}-${mm}-${dd}`;

      // restore draft (your original applyDraft/collectDraft)
      const saved = localStorage.getItem(DRAFT_KEY);
      if (saved){
        try{
          applyDraft(JSON.parse(saved));
          setText($("autosavePill"), "Autosave: loaded");
          if ($("draftStatus")) setText($("draftStatus"), "Yes");
          toast("Draft loaded", "We restored a saved draft from this device. You may need to re-attach files.");
        }catch(_){}
      }

      // ensure at least one exp and two refs (original)
      try{
        if (document.querySelectorAll("#expContainer .exp-card").length === 0 && $("expContainer")){
          $("expContainer").appendChild(makeExpCard());
        }
        if (document.querySelectorAll("#refsContainer .ref-card").length === 0 && $("refsContainer")){
          $("refsContainer").appendChild(makeRefCard());
          $("refsContainer").appendChild(makeRefCard());
        }
      }catch(_){}

      try{ updateProgress(); }catch(_){}
    })();
  </script>
</body>
</html>
