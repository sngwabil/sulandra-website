<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LPN Application | Sulandra Community Living Services</title>
  <meta name="description" content="Licensed Practical Nurse (LPN) application with resume upload, license details, work history, references, and file uploads saved to Firebase." />

  <style>
    :root{
      --bg:#f6f7f8;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --border:#d1d5db;
      --brand:#1f5aa6;
      --focus:#2563eb;
      --danger:#b91c1c;
      --ok:#166534;
      --shadow: 0 6px 18px rgba(0,0,0,.08);
      --radius: 14px;

      --primary:#004b8d;
      --secondary:#0077c8;
      --accent:#d14124;
      --line:#e7eef8;

      --headerH:80px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--text); }
    a{ color:inherit; text-decoration:none; }
    img{ max-width:100%; display:block; }

    .alert-bar{
      background:var(--accent);
      color:#fff;
      text-align:center;
      padding:10px 20px;
      font-size:14px;
      font-weight:800;
    }

    header{
      position:sticky;
      top:0;
      z-index:1000;
      background:#fff;
      border-bottom:1px solid #ddd;
    }
    .top-nav{
      max-width:1200px;
      margin:0 auto;
      padding:15px 20px;
      height:var(--headerH);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    .logo{ display:flex; align-items:center; min-width:0; }
    .logo img{
      width:240px;
      height:auto;
      max-height:100%;
      object-fit:contain;
    }
    .sr-only{
      position:absolute;
      width:1px;height:1px;
      padding:0;margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }
    .header-tools{
      display:flex;
      gap:16px;
      align-items:center;
      font-size:14px;
      font-weight:700;
      white-space:nowrap;
    }
    .header-tools a{ color:var(--text); }
    .btn-cta{
      background:var(--primary);
      color:#fff !important;
      padding:10px 16px;
      border-radius:6px;
      font-weight:800;
    }

    .main-nav{
      background:#fff;
      border-top:1px solid #eee;
    }
    .nav-links{
      max-width:1200px;
      margin:0 auto;
      list-style:none;
      display:flex;
      gap:2px;
      padding:0 10px;
    }
    .nav-links a{
      display:block;
      padding:12px 14px;
      border-radius:10px;
      font-weight:800;
      color:#20446e;
    }
    .nav-links a:hover{ background:#f2f6ff; }
    .nav-links a.active{
      background:#eaf2ff;
      color:#1f5aa6;
      box-shadow: inset 0 0 0 1px #d7e6ff;
    }

    .wrap{ max-width: 1140px; margin:0 auto; padding:18px 16px; }
    main .grid{
      display:grid; grid-template-columns: 1.25fr .75fr; gap: 18px;
      align-items:start; margin-top: 18px;
    }
    @media (max-width: 920px){ main .grid{ grid-template-columns: 1fr; } }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 22px;
    }

    .card h2{ margin:0 0 4px; font-size: 18px; font-weight: 850; }
    .card p.sub{ margin:0 0 14px; color: var(--muted); font-size: 13px; }

    .section{ border-top: 1px dashed var(--border); padding-top: 16px; margin-top: 22px; }
    .section .minihead{ display:flex; align-items:baseline; justify-content:space-between; gap:10px; }
    .section .minihead small{ color: var(--muted); }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 680px){ .row{ grid-template-columns: 1fr; } }

    label{
      display:block; font-weight: 750; font-size: 12px; margin-bottom: 6px;
      color: var(--brand); text-transform: uppercase; letter-spacing: 0.5px;
    }
    .hint{ font-size: 12px; color: var(--muted); margin-top: 6px; }

    input[type="text"], input[type="email"], input[type="tel"],
    input[type="number"], input[type="date"], input[type="url"],
    select, textarea{
      width:100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      font-size: 14px;
      background:#fff;
      outline: none;
    }
    textarea{ min-height: 92px; resize: vertical; }

    input:focus, select:focus, textarea:focus{
      border-color: var(--focus);
      box-shadow: 0 0 0 3px rgba(37,99,235,.15);
    }

    .checkboxline, .radioline{
      display:flex; gap:10px; align-items:flex-start;
      margin: 10px 0; font-size: 14px;
    }
    .checkboxline input, .radioline input{ transform: translateY(2px); }

    .btnrow{
      display:flex; gap: 12px; flex-wrap:wrap; margin-top: 18px;
      align-items:center;
    }
    button{
      border: 0; border-radius: 12px;
      padding: 14px 22px;
      font-weight: 850;
      cursor:pointer;
      font-size: 15px;
      transition: transform .05s ease, filter 0.2s ease, background 0.2s ease;
    }
    button:active{ transform: translateY(1px); }
    .primary{ background: var(--brand); color:#fff; }
    .primary:hover{ filter: brightness(0.95); }
    .ghost{
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }
    .ghost:hover{ background: #f9fafb; }
    .danger{
      background: #fee2e2;
      color: #7f1d1d;
      border: 1px solid #fecaca;
    }

    .side h3{
      margin: 0 0 10px; font-size: 12px;
      text-transform: uppercase; color: var(--brand);
      letter-spacing:.6px;
    }
    .kv{
      display:flex; justify-content:space-between; gap: 10px;
      padding: 10px 0; border-bottom: 1px solid rgba(209,213,219,.6);
      font-size: 13px;
    }
    .kv span:first-child{ color: var(--muted); font-weight: 650; }
    .kv span:last-child{ font-weight: 800; text-align: right; }

    .required::after{ content:" *"; color: var(--danger); font-weight:800; }

    .file-input-wrapper{ position: relative; overflow: hidden; display:block; width: 100%; }
    .file-input-wrapper input[type=file]{
      font-size: 100px; position:absolute; left:0; top:0;
      opacity:0; cursor:pointer; width:100%; height:100%;
    }
    .file-custom-btn{
      display:flex; justify-content:space-between; gap:12px; align-items:center;
      padding: 12px;
      border: 2px dashed var(--border);
      border-radius: 10px;
      color: var(--muted);
      font-weight: 650;
      background: #fafafa;
    }
    .file-input-wrapper:hover .file-custom-btn{ border-color: var(--brand); color: var(--brand); }
    .file-meta{ font-size: 12px; color: var(--muted); margin-top: 8px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px; border-radius: 999px;
      border: 1px solid var(--border); background:#fff;
      font-size: 12px; color: var(--muted); font-weight: 650;
      white-space:nowrap;
    }

    .filelist{
      margin-top:10px;
      border:1px solid rgba(209,213,219,.7);
      border-radius:12px;
      padding:10px;
      background:#fff;
    }
    .fileitem{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:8px 0;
      border-bottom:1px solid rgba(209,213,219,.55);
      font-size:13px;
    }
    .fileitem:last-child{ border-bottom:0; }
    .fileitem .meta{ color:var(--muted); font-weight:650; }
    .fileitem a{ color: var(--brand); text-decoration: underline; }

    .statusbar{
      display:none;
      margin-top: 14px;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: #fcfcfd;
    }
    .statusbar.show{ display:block; }
    .statusrow{ display:flex; justify-content:space-between; gap:10px; align-items:center; font-size: 13px; }
    .progress{
      height: 10px; border-radius: 999px; background: #eef2ff;
      border: 1px solid rgba(209,213,219,.7);
      overflow:hidden; margin-top: 10px;
    }
    .progress > div{
      height: 100%; width: 0%;
      background: linear-gradient(90deg, var(--brand), var(--focus));
      transition: width .25s ease;
    }

    .toast{
      position: fixed;
      right: 16px; bottom: 16px;
      width: min(420px, calc(100vw - 32px));
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 14px;
      display:none;
      z-index: 999;
    }
    .toast.show{ display:block; }
    .toast strong{ display:block; margin-bottom:4px; }
    .toast small{ color: var(--muted); }
    .toast .tbtns{ margin-top: 10px; display:flex; gap:10px; flex-wrap:wrap; }
    .toast .tbtns button{ padding:10px 14px; font-size: 13px; border-radius: 10px; }

    .error{
      margin-top: 8px;
      color: var(--danger);
      font-size: 12px;
      display:none;
    }
    .error.show{ display:block; }

    .ref-card, .exp-card{
      border: 1px solid rgba(209,213,219,.7);
      border-radius: 14px;
      padding: 14px;
      margin-top: 12px;
      background:#fff;
    }
    .ref-head, .exp-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
    }
    .ref-head strong, .exp-head strong{ font-size: 13px; }
    .ref-head button, .exp-head button{ padding: 8px 12px; font-size: 13px; border-radius: 10px; }

    .small{ font-size: 13px; color: var(--text); }
    .muted{ color: var(--muted); }

    @media (max-width: 800px){
      :root{ --headerH:72px; }
      .alert-bar{ font-size:13px; padding:10px 12px; }
      .top-nav{ padding:12px 14px; gap:12px; }
      .logo img{ width:200px; }
      .header-tools{ gap:10px; }
      .header-tools a:not(.btn-cta){ display:none; }
      .nav-links{
        overflow-x:auto;
        -webkit-overflow-scrolling:touch;
        scrollbar-width:none;
      }
      .nav-links::-webkit-scrollbar{ display:none; }
      .nav-links a{ padding:14px 14px; }
    }
  </style>
</head>

<body>
  <div class="alert-bar">
    Sulandra Health is changing the way the world ages. Call us today for a free consultation.
  </div>

  <header>
    <div class="top-nav">
      <a href="/index.html" class="logo" aria-label="Sulandra Health Home">
        <img src="/assets/mainlogo.png" alt="Sulandra Health Logo" />
        <span class="sr-only">Sulandra Health</span>
      </a>

      <div class="header-tools">
        <a href="#">Reviews</a>
        <a href="#">Resources</a>
        <a href="#" class="btn-cta">Free Consultation</a>
      </div>
    </div>

    <nav class="main-nav" aria-label="Primary">
      <ul class="nav-links">
        <li><a href="/index.html">Home</a></li>
        <li><a href="/services.html">Services</a></li>
        <li><a class="active" href="/Careers.html">Careers</a></li>
        <li><a href="#">About Us</a></li>
        <li><a href="#">Contact</a></li>
      </ul>
    </nav>
  </header>

  <main class="wrap" role="main">
    <div class="grid">
      <section class="card" aria-label="LPN application form">
        <h2>Application for: Licensed Practical Nurse (LPN)</h2>
        <p class="sub">Complete the form below. Required fields are marked with an asterisk.</p>

        <form id="appForm" method="post" action="#" enctype="multipart/form-data" novalidate>
          <input type="hidden" name="jobTitle" value="Licensed Practical Nurse (LPN)" />
          <input type="hidden" name="company" value="Sulandra Community Living Services" />
          <input type="hidden" name="version" value="2.0" />

          <div class="section" style="border-top:none; padding-top:0; margin-top:0;">
            <div class="minihead">
              <h2>Basic Information</h2>
              <small>Step 1</small>
            </div>

            <div class="row">
              <div>
                <label class="required" for="firstName">First name</label>
                <input id="firstName" name="firstName" type="text" autocomplete="given-name" required />
                <div class="error" id="err-firstName">Please enter your first name.</div>
              </div>
              <div>
                <label class="required" for="lastName">Last name</label>
                <input id="lastName" name="lastName" type="text" autocomplete="family-name" required />
                <div class="error" id="err-lastName">Please enter your last name.</div>
              </div>
            </div>

            <div class="row" style="margin-top:16px;">
              <div>
                <label class="required" for="email">Email</label>
                <input id="email" name="email" type="email" autocomplete="email" required />
                <div class="error" id="err-email">Please enter a valid email.</div>
              </div>
              <div>
                <label class="required" for="phone">Phone</label>
                <input id="phone" name="phone" type="tel" autocomplete="tel" placeholder="(555) 555-5555" required />
                <div class="error" id="err-phone">Please enter a valid phone number.</div>
              </div>
            </div>

            <div class="row" style="margin-top:16px;">
              <div>
                <label class="required" for="address1">Address</label>
                <input id="address1" name="address1" type="text" autocomplete="address-line1" required />
                <div class="error" id="err-address1">Please enter your address.</div>
              </div>
              <div>
                <label for="address2">Apt / Unit</label>
                <input id="address2" name="address2" type="text" autocomplete="address-line2" />
              </div>
            </div>

            <div class="row" style="margin-top:16px;">
              <div>
                <label class="required" for="city">City</label>
                <input id="city" name="city" type="text" autocomplete="address-level2" required />
                <div class="error" id="err-city">Please enter your city.</div>
              </div>
              <div>
                <label class="required" for="state">State</label>
                <select id="state" name="state" autocomplete="address-level1" required>
                  <option value="">Select…</option>
                  <option>AL</option><option>AK</option><option>AZ</option><option>AR</option><option>CA</option><option>CO</option>
                  <option>CT</option><option>DE</option><option>FL</option><option>GA</option><option>HI</option><option>ID</option>
                  <option>IL</option><option>IN</option><option>IA</option><option>KS</option><option>KY</option><option>LA</option>
                  <option>ME</option><option>MD</option><option>MA</option><option>MI</option><option>MN</option><option>MS</option>
                  <option>MO</option><option>MT</option><option>NE</option><option>NV</option><option>NH</option><option>NJ</option>
                  <option>NM</option><option>NY</option><option>NC</option><option>ND</option><option>OH</option><option>OK</option>
                  <option>OR</option><option>PA</option><option>RI</option><option>SC</option><option>SD</option><option>TN</option>
                  <option>TX</option><option>UT</option><option>VT</option><option>VA</option><option>WA</option><option>WV</option>
                  <option>WI</option><option>WY</option>
                </select>
                <div class="error" id="err-state">Please select your state.</div>
              </div>
            </div>

            <div class="row" style="margin-top:16px;">
              <div>
                <label class="required" for="zip">ZIP</label>
                <input id="zip" name="zip" type="text" inputmode="numeric" autocomplete="postal-code" required />
                <div class="error" id="err-zip">Please enter a valid ZIP code.</div>
              </div>
              <div>
                <label class="required" for="startDate">Earliest start date</label>
                <input id="startDate" name="startDate" type="date" required />
                <div class="error" id="err-startDate">Please select a start date.</div>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="minihead">
              <h2>License & Credentials</h2>
              <small>Step 2</small>
            </div>
            <p class="sub">Provide your LPN license details and current certifications.</p>

            <div class="row">
              <div>
                <label class="required" for="lpnLicenseNumber">LPN license number</label>
                <input id="lpnLicenseNumber" name="lpnLicenseNumber" type="text" required />
                <div class="error" id="err-lpnLicenseNumber">License number is required.</div>
              </div>
              <div>
                <label class="required" for="lpnLicenseState">Issuing state</label>
                <select id="lpnLicenseState" name="lpnLicenseState" required>
                  <option value="">Select…</option>
                  <option>AL</option><option>AK</option><option>AZ</option><option>AR</option><option>CA</option><option>CO</option>
                  <option>CT</option><option>DE</option><option>FL</option><option>GA</option><option>HI</option><option>ID</option>
                  <option>IL</option><option>IN</option><option>IA</option><option>KS</option><option>KY</option><option>LA</option>
                  <option>ME</option><option>MD</option><option>MA</option><option>MI</option><option>MN</option><option>MS</option>
                  <option>MO</option><option>MT</option><option>NE</option><option>NV</option><option>NH</option><option>NJ</option>
                  <option>NM</option><option>NY</option><option>NC</option><option>ND</option><option>OH</option><option>OK</option>
                  <option>OR</option><option>PA</option><option>RI</option><option>SC</option><option>SD</option><option>TN</option>
                  <option>TX</option><option>UT</option><option>VT</option><option>VA</option><option>WA</option><option>WV</option>
                  <option>WI</option><option>WY</option>
                </select>
                <div class="error" id="err-lpnLicenseState">Issuing state is required.</div>
              </div>
            </div>

            <div class="row" style="margin-top:16px;">
              <div>
                <label class="required" for="lpnLicenseExp">License expiration date</label>
                <input id="lpnLicenseExp" name="lpnLicenseExp" type="date" required />
                <div class="error" id="err-lpnLicenseExp">Expiration date is required.</div>
              </div>
              <div>
                <label for="npi">NPI number (optional)</label>
                <input id="npi" name="npi" type="text" />
              </div>
            </div>

            <div style="margin-top:16px;">
              <label class="required">Current certifications (select all that apply)</label>
              <div class="checkboxline"><input type="checkbox" name="certs" value="BLS" /> <span>BLS (Basic Life Support)</span></div>
              <div class="checkboxline"><input type="checkbox" name="certs" value="CPR" /> <span>CPR</span></div>
              <div class="checkboxline"><input type="checkbox" name="certs" value="First Aid" /> <span>First Aid</span></div>
              <div class="checkboxline"><input type="checkbox" name="certs" value="IV Therapy" /> <span>IV Therapy / IV Certification</span></div>
              <div class="checkboxline"><input type="checkbox" name="certs" value="Other" /> <span>Other</span></div>
              <div class="checkboxline"><input type="checkbox" id="cert_none" name="cert_none" value="none" /> <span><strong>No current certifications</strong></span></div>
              <div class="error" id="err-certs">Please select at least one option (or select “No current certifications”).</div>
            </div>

            <div style="margin-top:16px;">
              <label for="skills">Clinical skills / specialties (optional)</label>
              <textarea id="skills" name="skills" placeholder="e.g., wound care, medication administration, vitals, charting, geriatrics, pediatrics, behavioral health, etc."></textarea>
            </div>
          </div>

          <div class="section">
            <div class="minihead">
              <h2>Availability & Preferences</h2>
              <small>Step 3</small>
            </div>

            <div class="row">
              <div>
                <label class="required" for="employmentType">Employment type</label>
                <select id="employmentType" name="employmentType" required>
                  <option value="">Select…</option>
                  <option value="full-time">Full-time</option>
                  <option value="part-time">Part-time</option>
                  <option value="prn">PRN / As-needed</option>
                  <option value="seasonal">Seasonal</option>
                </select>
                <div class="error" id="err-employmentType">Please select an employment type.</div>
              </div>
              <div>
                <label class="required" for="shiftPref">Preferred shift</label>
                <select id="shiftPref" name="shiftPref" required>
                  <option value="">Select…</option>
                  <option value="1st">1st Shift (Morning/Day)</option>
                  <option value="2nd">2nd Shift (Afternoon/Evening)</option>
                  <option value="3rd">3rd Shift (Overnight)</option>
                  <option value="weekend">Weekends Only</option>
                  <option value="flexible">Flexible</option>
                </select>
                <div class="error" id="err-shiftPref">Please select a shift preference.</div>
              </div>
            </div>

            <div class="row" style="margin-top:16px;">
              <div>
                <label for="hoursPerWeek">Desired hours per week</label>
                <input id="hoursPerWeek" name="hoursPerWeek" type="number" min="0" max="80" step="1" placeholder="e.g., 36" />
              </div>
              <div>
                <label for="reliableTransport">Reliable transportation?</label>
                <select id="reliableTransport" name="reliableTransport">
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>
            </div>

            <div style="margin-top:16px;">
              <label class="required">Days available</label>
              <div class="row">
                <div>
                  <div class="checkboxline"><input type="checkbox" name="days" value="Mon" /> <span>Monday</span></div>
                  <div class="checkboxline"><input type="checkbox" name="days" value="Tue" /> <span>Tuesday</span></div>
                  <div class="checkboxline"><input type="checkbox" name="days" value="Wed" /> <span>Wednesday</span></div>
                  <div class="checkboxline"><input type="checkbox" name="days" value="Thu" /> <span>Thursday</span></div>
                </div>
                <div>
                  <div class="checkboxline"><input type="checkbox" name="days" value="Fri" /> <span>Friday</span></div>
                  <div class="checkboxline"><input type="checkbox" name="days" value="Sat" /> <span>Saturday</span></div>
                  <div class="checkboxline"><input type="checkbox" name="days" value="Sun" /> <span>Sunday</span></div>
                </div>
              </div>
              <div class="error" id="err-days">Please select at least one day.</div>
            </div>
          </div>

          <div class="section">
            <div class="minihead">
              <h2>Education</h2>
              <small>Step 4</small>
            </div>

            <div class="row">
              <div>
                <label class="required" for="school">School / Program</label>
                <input id="school" name="school" type="text" required />
                <div class="error" id="err-school">School/program is required.</div>
              </div>
              <div>
                <label class="required" for="gradYear">Graduation year</label>
                <input id="gradYear" name="gradYear" type="number" min="1950" max="2100" placeholder="e.g., 2023" required />
                <div class="error" id="err-gradYear">Graduation year is required.</div>
              </div>
            </div>

            <div class="row" style="margin-top:16px;">
              <div>
                <label for="educationNotes">Additional education notes (optional)</label>
                <input id="educationNotes" name="educationNotes" type="text" placeholder="e.g., honors, clinical focus, etc." />
              </div>
              <div>
                <label for="ehr">EHR experience (optional)</label>
                <input id="ehr" name="ehr" type="text" placeholder="e.g., Epic, Cerner, PointClickCare" />
              </div>
            </div>
          </div>

          <div class="section">
            <div class="minihead">
              <h2>Work Experience</h2>
              <small>Step 5</small>
            </div>
            <p class="sub">Add at least one recent job.</p>

            <div class="error" id="err-exp">Please add at least one complete work experience.</div>
            <div id="expContainer"></div>

            <div class="btnrow">
              <button type="button" class="ghost" id="addExpBtn">+ Add Work Experience</button>
            </div>
          </div>

          <div class="section">
            <div class="minihead">
              <h2>Resume & Documents</h2>
              <small>Step 6</small>
            </div>

            <div>
              <label class="required" for="resume">Resume (PDF, DOC, DOCX)</label>
              <div class="file-input-wrapper" style="min-height:54px;">
                <div class="file-custom-btn">
                  <span id="resume-chosen">Click to choose resume…</span>
                  <span class="pill" id="resume-pill">No file</span>
                </div>
                <input type="file" id="resume" name="resume" accept=".pdf,.doc,.docx" required />
              </div>
              <div class="file-meta" id="resume-meta">Max 10MB. Required.</div>
              <div class="error" id="err-resume">Please upload your resume (10MB or less).</div>
              <div class="filelist" id="resume-list" style="display:none;"></div>
            </div>

            <div style="margin-top:16px;">
              <label for="coverLetter">Cover letter (optional)</label>
              <div class="file-input-wrapper" style="min-height:54px;">
                <div class="file-custom-btn">
                  <span id="cover-chosen">Click to choose cover letter…</span>
                  <span class="pill" id="cover-pill">Optional</span>
                </div>
                <input type="file" id="coverLetter" name="coverLetter" accept=".pdf,.doc,.docx" />
              </div>
              <div class="file-meta">Max 10MB.</div>
              <div class="filelist" id="cover-list" style="display:none;"></div>
            </div>

            <div style="margin-top:16px;">
              <label for="licenseDoc">License / certification documents (optional, multiple)</label>
              <div class="file-input-wrapper" style="min-height:54px;">
                <div class="file-custom-btn">
                  <span id="license-chosen">Click to choose documents…</span>
                  <span class="pill" id="license-pill">Optional</span>
                </div>
                <input type="file" id="licenseDoc" name="licenseDoc" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" multiple />
              </div>
              <div class="file-meta">Max 10MB per file.</div>
              <div class="filelist" id="license-list" style="display:none;"></div>
            </div>

            <div class="helpbox" style="margin-top:12px;">
              <strong class="small">Uploads:</strong>
              <span class="muted">On submit, all selected files are uploaded to Firebase Storage and saved with your application. The uploaded file links will appear below after submit.</span>
            </div>

            <div class="filelist" id="uploaded-files" style="display:none; margin-top:14px;">
              <div style="font-weight:850; margin-bottom:8px;">Uploaded files (this submission)</div>
              <div id="uploaded-files-items"></div>
            </div>
          </div>

          <div class="section">
            <div class="minihead">
              <h2>Screening Questions</h2>
              <small>Step 7</small>
            </div>

            <div class="row">
              <div>
                <label class="required" for="yearsLpn">Years of LPN experience</label>
                <select id="yearsLpn" name="yearsLpn" required>
                  <option value="">Select…</option>
                  <option value="0">New Grad / 0 years</option>
                  <option value="lt1">Less than 1 year</option>
                  <option value="1-2">1–2 years</option>
                  <option value="3-5">3–5 years</option>
                  <option value="5plus">5+ years</option>
                </select>
                <div class="error" id="err-yearsLpn">Please select your experience level.</div>
              </div>
              <div>
                <label class="required" for="workAuth">Work authorization (U.S.)</label>
                <select id="workAuth" name="workAuth" required>
                  <option value="">Select…</option>
                  <option value="yes">I am authorized to work in the U.S.</option>
                  <option value="needSponsor">I will need sponsorship now or in the future</option>
                </select>
                <div class="error" id="err-workAuth">Please select an option.</div>
              </div>
            </div>

            <div style="margin-top:16px;">
              <label class="required">Can you pass a background check and drug screening?</label>
              <div class="radioline">
                <input type="radio" name="screening" value="yes" required />
                <span>Yes, I consent to screening.</span>
              </div>
              <div class="radioline">
                <input type="radio" name="screening" value="no" />
                <span>No.</span>
              </div>
              <div class="error" id="err-screening">Please select an option.</div>
            </div>

            <div style="margin-top:16px;">
              <label for="why">Why are you interested in this LPN role? (optional)</label>
              <textarea id="why" name="why" placeholder="Tell us briefly what interests you about this position."></textarea>
            </div>
          </div>

          <div class="section">
            <div class="minihead">
              <h2>Professional References</h2>
              <small>Step 8</small>
            </div>
            <p class="sub">Provide at least two professional references. You may add more.</p>

            <div class="error" id="err-refs">Please provide at least 2 complete references.</div>

            <div class="checkboxline" style="margin-top:0;">
              <input id="consentContactRefs" name="consentContactRefs" type="checkbox" required />
              <label for="consentContactRefs" style="display:inline; color:var(--text); font-weight:550; text-transform:none; letter-spacing:0;">
                I consent to contact my references.
              </label>
            </div>
            <div class="error" id="err-consentContactRefs">Consent to contact references is required.</div>

            <div id="refsContainer"></div>

            <div class="btnrow">
              <button type="button" class="ghost" id="addRefBtn">+ Add Reference</button>
            </div>
          </div>

          <div class="section">
            <div class="minihead">
              <h2>Agreement & Signature</h2>
              <small>Step 9</small>
            </div>

            <div class="checkboxline">
              <input id="consentTruth" name="consentTruth" type="checkbox" required />
              <label for="consentTruth" style="display:inline; color:var(--text); font-weight:550; text-transform:none; letter-spacing:0;">
                I certify that the information provided is true and complete to the best of my knowledge.
              </label>
            </div>
            <div class="error" id="err-consentTruth">This acknowledgement is required.</div>

            <div class="checkboxline">
              <input id="consentESign" name="consentESign" type="checkbox" required />
              <label for="consentESign" style="display:inline; color:var(--text); font-weight:550; text-transform:none; letter-spacing:0;">
                I agree that typing my name below serves as my electronic signature.
              </label>
            </div>
            <div class="error" id="err-consentESign">E-sign consent is required.</div>

            <div class="row" style="margin-top:12px;">
              <div>
                <label class="required" for="signature">Electronic signature (type full name)</label>
                <input id="signature" name="signature" type="text" required />
                <div class="error" id="err-signature">Please type your full name as signature.</div>
              </div>
              <div>
                <label class="required" for="signatureDate">Signature date</label>
                <input id="signatureDate" name="signatureDate" type="date" required />
                <div class="error" id="err-signatureDate">Please select a date.</div>
              </div>
            </div>

            <div class="btnrow">
              <button type="submit" class="primary" id="submitBtn">Submit Application</button>
              <button type="button" class="ghost" id="saveBtn">Save & Continue Later</button>
              <button type="button" class="ghost" id="previewBtn">Preview</button>
              <button type="button" class="danger" id="resetBtn">Clear Form</button>
              <span class="pill" id="autosavePill" title="Autosave status">Autosave: off</span>
            </div>

            <div class="statusbar" id="statusbar" aria-live="polite">
              <div class="statusrow">
                <strong id="statusTitle">Submitting…</strong>
                <span class="muted" id="statusHint">Please don’t close this tab.</span>
              </div>
              <div class="progress" aria-label="Submission progress">
                <div id="progressFill"></div>
              </div>
            </div>
          </div>
        </form>
      </section>

      <aside class="side" aria-label="Job overview">
        <div class="card">
          <h3>Position Summary</h3>
          <div class="kv"><span>Role:</span><span>Licensed Practical Nurse (LPN)</span></div>
          <div class="kv"><span>Location:</span><span>Home & Community Based</span></div>
          <div class="kv"><span>Department:</span><span>Clinical Services</span></div>
          <div class="kv"><span>Type:</span><span>Full-Time / Part-Time / PRN</span></div>

          <div style="margin-top:16px;">
            <h3>Core Responsibilities</h3>
            <p class="small">
              • Provide direct nursing care within scope (vitals, meds, documentation).<br>
              • Support clinical plans and report changes in condition.<br>
              • Collaborate with RNs/lead staff and follow agency protocols.<br>
              • Maintain accurate records and uphold confidentiality.
            </p>
          </div>
        </div>

        <div class="card" style="margin-top:18px;">
          <h3>Progress</h3>
          <div class="kv"><span>Required fields complete:</span><span id="reqCount">0%</span></div>
          <div class="kv"><span>Resume selected:</span><span id="resumeStatus">No</span></div>
          <div class="kv"><span>Draft saved:</span><span id="draftStatus">No</span></div>
          <div class="kv"><span>References:</span><span id="refsStatus">0/2</span></div>
          <div class="kv"><span>Work experience:</span><span id="expStatus">0</span></div>
          <div class="kv"><span>Files selected:</span><span id="filesStatus">0</span></div>
          <div class="hint">Draft saves to your browser (localStorage). Files must be re-attached after reload.</div>
        </div>
      </aside>
    </div>
  </main>

  <div class="toast" id="toast" role="status" aria-live="polite">
    <strong id="toastTitle">Saved</strong>
    <small id="toastBody">Your draft has been saved on this device.</small>
    <div class="tbtns">
      <button class="ghost" id="toastCloseBtn" type="button">Close</button>
      <button class="primary" id="toastDownloadBtn" type="button">Download copy (JSON)</button>
    </div>
  </div>

  <script type="module">
    /* ==========================================================
       Firebase (Firestore + Storage) + Fully functional submission
       ========================================================== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    // Your Firebase config (same project you used on DSP)
    const firebaseConfig = {
      apiKey: "AIzaSyCi3Qtyka_PJsHT9Ln7LJZp2BCqOxW3lM8",
      authDomain: "sulandra-health-portal.firebaseapp.com",
      projectId: "sulandra-health-portal",
      storageBucket: "sulandra-health-portal.firebasestorage.app",
      messagingSenderId: "547316167712",
      appId: "1:547316167712:web:24dfc2c5bd9d0296b4f845",
      measurementId: "G-N2M4L7YMNB"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    /* ==========
       Utilities
       ========== */
    const $ = (id) => document.getElementById(id);

    const DRAFT_KEY = "scls_apply_lpn_v2_draft";
    const MAX_FILE_MB = 10;
    const MAX_FILE_BYTES = MAX_FILE_MB * 1024 * 1024;

    function show(el, on=true){ el.classList.toggle("show", !!on); }
    function setText(el, t){ el.textContent = t; }
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function toast(title, body){
      setText($("toastTitle"), title);
      setText($("toastBody"), body || "");
      show($("toast"), true);
    }
    $("toastCloseBtn").addEventListener("click", () => show($("toast"), false));

    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function bytesToHuman(bytes){
      const u = ["B","KB","MB","GB"];
      let i = 0, n = Number(bytes||0);
      while(n >= 1024 && i < u.length-1){ n/=1024; i++; }
      return `${n.toFixed(n<10 && i>0 ? 1 : 0)} ${u[i]}`;
    }

    function isEmail(v){
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(v || "").trim());
    }
    function isPhone(v){
      const s = String(v || "").replace(/[^\d]/g, "");
      return s.length >= 10;
    }
    function isZip(v){
      return /^\d{5}(-\d{4})?$/.test(String(v||"").trim());
    }
    function fileOk(file){
      if (!file) return true;
      return file.size <= MAX_FILE_BYTES;
    }
    function hasAnyChecked(name){
      return Array.from(document.querySelectorAll(`input[name="${CSS.escape(name)}"]`)).some(i => i.checked);
    }
    function getChecked(name){
      return Array.from(document.querySelectorAll(`input[name="${CSS.escape(name)}"]:checked`)).map(i => i.value);
    }

    /* ==========
       Status bar
       ========== */
    function setSubmitting(on){
      $("submitBtn").disabled = on;
      $("saveBtn").disabled = on;
      $("previewBtn").disabled = on;
      $("resetBtn").disabled = on;
      show($("statusbar"), on);
    }
    function setProgress(pct, title, hint){
      $("progressFill").style.width = `${clamp(pct,0,100)}%`;
      if(title) setText($("statusTitle"), title);
      if(hint) setText($("statusHint"), hint);
    }

    /* ==========
       Dynamic Work Experience
       ========== */
    let expCount = 0;

    function makeExpCard(data = {}){
      expCount += 1;
      const idx = expCount;

      const wrap = document.createElement("div");
      wrap.className = "exp-card";
      wrap.dataset.exp = String(idx);

      wrap.innerHTML = `
        <div class="exp-head">
          <strong>Work Experience #${idx}</strong>
          <button type="button" class="danger" aria-label="Remove experience">Remove</button>
        </div>

        <div class="row">
          <div>
            <label class="required" for="exp_employer_${idx}">Employer</label>
            <input id="exp_employer_${idx}" name="exp_employer_${idx}" type="text" required value="${escapeHtml(data.employer || "")}">
            <div class="error" id="err-exp_employer_${idx}">Employer is required.</div>
          </div>
          <div>
            <label class="required" for="exp_title_${idx}">Job title</label>
            <input id="exp_title_${idx}" name="exp_title_${idx}" type="text" required value="${escapeHtml(data.title || "")}">
            <div class="error" id="err-exp_title_${idx}">Job title is required.</div>
          </div>
        </div>

        <div class="row" style="margin-top:16px;">
          <div>
            <label class="required" for="exp_start_${idx}">Start date</label>
            <input id="exp_start_${idx}" name="exp_start_${idx}" type="date" required value="${escapeHtml(data.start || "")}">
            <div class="error" id="err-exp_start_${idx}">Start date is required.</div>
          </div>
          <div>
            <label class="required" for="exp_end_${idx}">End date</label>
            <input id="exp_end_${idx}" name="exp_end_${idx}" type="date" required value="${escapeHtml(data.end || "")}">
            <div class="error" id="err-exp_end_${idx}">End date is required.</div>
          </div>
        </div>

        <div style="margin-top:16px;">
          <label class="required" for="exp_reason_${idx}">Reason for leaving</label>
          <textarea id="exp_reason_${idx}" name="exp_reason_${idx}" required placeholder="Brief explanation">${escapeHtml(data.reason || "")}</textarea>
          <div class="error" id="err-exp_reason_${idx}">Reason for leaving is required.</div>
        </div>

        <div class="row" style="margin-top:16px;">
          <div>
            <label for="exp_supervisorPhone_${idx}">Supervisor/HR phone (optional)</label>
            <input id="exp_supervisorPhone_${idx}" name="exp_supervisorPhone_${idx}" type="tel" placeholder="(555) 555-5555" value="${escapeHtml(data.supervisorPhone || "")}">
          </div>
          <div>
            <label class="required" for="exp_contactOk_${idx}">Consent to contact?</label>
            <select id="exp_contactOk_${idx}" name="exp_contactOk_${idx}" required>
              <option value="">Select…</option>
              <option value="yes" ${data.contactOk === "yes" ? "selected" : ""}>Yes</option>
              <option value="no" ${data.contactOk === "no" ? "selected" : ""}>No</option>
            </select>
            <div class="error" id="err-exp_contactOk_${idx}">Please select an option.</div>
          </div>
        </div>
      `;

      wrap.querySelector("button.danger").addEventListener("click", () => {
        wrap.remove();
        updateProgress();
        scheduleAutosave(true);
      });

      wrap.addEventListener("input", () => { scheduleAutosave(); updateProgress(); });
      wrap.addEventListener("change", () => { scheduleAutosave(); updateProgress(); });

      return wrap;
    }

    $("addExpBtn").addEventListener("click", () => {
      $("expContainer").appendChild(makeExpCard());
      updateProgress();
      scheduleAutosave(true);
    });

    /* ==========
       Dynamic References
       ========== */
    let refCount = 0;

    function makeRefCard(data = {}){
      refCount += 1;
      const idx = refCount;

      const wrap = document.createElement("div");
      wrap.className = "ref-card";
      wrap.dataset.ref = String(idx);

      wrap.innerHTML = `
        <div class="ref-head">
          <strong>Reference #${idx}</strong>
          <button type="button" class="danger" aria-label="Remove reference">Remove</button>
        </div>

        <div class="row">
          <div>
            <label class="required" for="ref_name_${idx}">Name</label>
            <input id="ref_name_${idx}" name="ref_name_${idx}" type="text" required value="${escapeHtml(data.name || "")}">
            <div class="error" id="err-ref_name_${idx}">Name is required.</div>
          </div>
          <div>
            <label class="required" for="ref_relation_${idx}">Relationship</label>
            <input id="ref_relation_${idx}" name="ref_relation_${idx}" type="text" required value="${escapeHtml(data.relation || "")}">
            <div class="error" id="err-ref_relation_${idx}">Relationship is required.</div>
          </div>
        </div>

        <div class="row" style="margin-top:16px;">
          <div>
            <label class="required" for="ref_phone_${idx}">Phone</label>
            <input id="ref_phone_${idx}" name="ref_phone_${idx}" type="tel" placeholder="(555) 555-5555" required value="${escapeHtml(data.phone || "")}">
            <div class="error" id="err-ref_phone_${idx}">Valid phone is required.</div>
          </div>
          <div>
            <label class="required" for="ref_email_${idx}">Email</label>
            <input id="ref_email_${idx}" name="ref_email_${idx}" type="email" required value="${escapeHtml(data.email || "")}">
            <div class="error" id="err-ref_email_${idx}">Valid email is required.</div>
          </div>
        </div>
      `;

      wrap.querySelector("button.danger").addEventListener("click", () => {
        wrap.remove();
        updateProgress();
        scheduleAutosave(true);
      });

      wrap.addEventListener("input", () => { scheduleAutosave(); updateProgress(); });
      wrap.addEventListener("change", () => { scheduleAutosave(); updateProgress(); });

      return wrap;
    }

    $("addRefBtn").addEventListener("click", () => {
      $("refsContainer").appendChild(makeRefCard());
      updateProgress();
      scheduleAutosave(true);
    });

    /* ==========
       File UI (show ALL selected files + sizes)
       ========== */
    function renderSelectedFileList(listEl, files){
      if(!files || files.length === 0){
        listEl.style.display = "none";
        listEl.innerHTML = "";
        return;
      }
      listEl.style.display = "block";
      listEl.innerHTML = "";
      Array.from(files).forEach(f => {
        const row = document.createElement("div");
        row.className = "fileitem";
        row.innerHTML = `
          <div>
            <div style="font-weight:800;">${escapeHtml(f.name)}</div>
            <div class="meta">${escapeHtml(f.type || "unknown")} • ${bytesToHuman(f.size)}</div>
          </div>
          <div class="meta">Selected</div>
        `;
        listEl.appendChild(row);
      });
    }

    function updateFileWidget(inputId, chosenId, pillId, listId, emptyLabel, emptyPill){
      const input = $(inputId);
      const files = input.files ? Array.from(input.files) : [];

      if(files.length === 0){
        setText($(chosenId), emptyLabel);
        setText($(pillId), emptyPill);
      }else if(files.length === 1){
        setText($(chosenId), files[0].name);
        setText($(pillId), bytesToHuman(files[0].size));
      }else{
        setText($(chosenId), `${files.length} files selected`);
        setText($(pillId), `${files.length} files`);
      }

      renderSelectedFileList($(listId), files);
      updateProgress();
      scheduleAutosave(true);
    }

    $("resume").addEventListener("change", () => updateFileWidget("resume","resume-chosen","resume-pill","resume-list","Click to choose resume…","No file"));
    $("coverLetter").addEventListener("change", () => updateFileWidget("coverLetter","cover-chosen","cover-pill","cover-list","Click to choose cover letter…","Optional"));
    $("licenseDoc").addEventListener("change", () => updateFileWidget("licenseDoc","license-chosen","license-pill","license-list","Click to choose documents…","Optional"));

    function countSelectedFiles(){
      const a = $("resume").files?.length || 0;
      const b = $("coverLetter").files?.length || 0;
      const c = $("licenseDoc").files?.length || 0;
      return a + b + c;
    }

    /* ==========
       Cert none logic
       ========== */
    $("cert_none").addEventListener("change", (e) => {
      if (e.target.checked){
        document.querySelectorAll('input[name="certs"]').forEach(cb => cb.checked = false);
      }
      scheduleAutosave(true);
      updateProgress();
    });

    document.querySelectorAll('input[name="certs"]').forEach(cb => {
      cb.addEventListener("change", () => {
        if (cb.checked) $("cert_none").checked = false;
        scheduleAutosave();
        updateProgress();
      });
    });

    /* ==========
       Validation helpers
       ========== */
    function setErr(id, on){
      const el = $(id);
      if (!el) return;
      el.classList.toggle("show", !!on);
    }

    function validateBasics(){
      let ok = true;

      const fn = $("firstName").value.trim();
      const ln = $("lastName").value.trim();
      const em = $("email").value.trim();
      const ph = $("phone").value.trim();
      const a1 = $("address1").value.trim();
      const city = $("city").value.trim();
      const st = $("state").value;
      const zip = $("zip").value.trim();
      const start = $("startDate").value;

      setErr("err-firstName", !fn); ok = ok && !!fn;
      setErr("err-lastName", !ln); ok = ok && !!ln;

      setErr("err-email", !isEmail(em)); ok = ok && isEmail(em);
      setErr("err-phone", !isPhone(ph)); ok = ok && isPhone(ph);

      setErr("err-address1", !a1); ok = ok && !!a1;
      setErr("err-city", !city); ok = ok && !!city;
      setErr("err-state", !st); ok = ok && !!st;
      setErr("err-zip", !isZip(zip)); ok = ok && isZip(zip);

      setErr("err-startDate", !start); ok = ok && !!start;

      return ok;
    }

    function validateLicense(){
      let ok = true;

      const num = $("lpnLicenseNumber").value.trim();
      const st = $("lpnLicenseState").value;
      const exp = $("lpnLicenseExp").value;

      setErr("err-lpnLicenseNumber", !num); ok = ok && !!num;
      setErr("err-lpnLicenseState", !st); ok = ok && !!st;
      setErr("err-lpnLicenseExp", !exp); ok = ok && !!exp;

      const anyCert = hasAnyChecked("certs");
      const none = $("cert_none").checked;
      setErr("err-certs", !(anyCert || none));
      ok = ok && (anyCert || none);

      return ok;
    }

    function validateAvailability(){
      let ok = true;

      const emp = $("employmentType").value;
      const shift = $("shiftPref").value;

      setErr("err-employmentType", !emp); ok = ok && !!emp;
      setErr("err-shiftPref", !shift); ok = ok && !!shift;

      const anyDay = hasAnyChecked("days");
      setErr("err-days", !anyDay);
      ok = ok && anyDay;

      return ok;
    }

    function validateEducation(){
      let ok = true;
      const school = $("school").value.trim();
      const gy = $("gradYear").value.trim();

      setErr("err-school", !school); ok = ok && !!school;
      setErr("err-gradYear", !gy); ok = ok && !!gy;

      return ok;
    }

    function validateExperience(){
      const cards = Array.from(document.querySelectorAll("#expContainer .exp-card"));
      if (cards.length === 0){
        setErr("err-exp", true);
        return false;
      }

      let completeCount = 0;

      for (const c of cards){
        const idx = c.dataset.exp;
        const employer = $(`exp_employer_${idx}`)?.value.trim();
        const title = $(`exp_title_${idx}`)?.value.trim();
        const start = $(`exp_start_${idx}`)?.value;
        const end = $(`exp_end_${idx}`)?.value;
        const reason = $(`exp_reason_${idx}`)?.value.trim();
        const contactOk = $(`exp_contactOk_${idx}`)?.value;
        if (employer && title && start && end && reason && contactOk) completeCount++;
      }

      const ok = completeCount >= 1;
      setErr("err-exp", !ok);
      return ok;
    }

    function validateResume(){
      const f = $("resume").files && $("resume").files[0] ? $("resume").files[0] : null;
      const ok = !!f && fileOk(f);
      setErr("err-resume", !ok);
      return ok;
    }

    function validateScreening(){
      let ok = true;

      const years = $("yearsLpn").value;
      const auth = $("workAuth").value;
      const screening = document.querySelector('input[name="screening"]:checked');

      setErr("err-yearsLpn", !years); ok = ok && !!years;
      setErr("err-workAuth", !auth); ok = ok && !!auth;

      setErr("err-screening", !screening); ok = ok && !!screening;

      return ok;
    }

    function validateRefs(){
      let ok = true;

      const consent = $("consentContactRefs").checked;
      setErr("err-consentContactRefs", !consent);
      ok = ok && consent;

      const cards = Array.from(document.querySelectorAll("#refsContainer .ref-card"));
      let complete = 0;

      for (const c of cards){
        const idx = c.dataset.ref;
        const name = $(`ref_name_${idx}`)?.value.trim();
        const rel = $(`ref_relation_${idx}`)?.value.trim();
        const ph = $(`ref_phone_${idx}`)?.value.trim();
        const em = $(`ref_email_${idx}`)?.value.trim();
        if (name && rel && isPhone(ph) && isEmail(em)) complete++;
      }

      setErr("err-refs", complete < 2);
      ok = ok && (complete >= 2);

      return ok;
    }

    function validateSignature(){
      let ok = true;

      const truth = $("consentTruth").checked;
      const esign = $("consentESign").checked;
      const sig = $("signature").value.trim();
      const date = $("signatureDate").value;

      setErr("err-consentTruth", !truth); ok = ok && truth;
      setErr("err-consentESign", !esign); ok = ok && esign;

      setErr("err-signature", !sig); ok = ok && !!sig;
      setErr("err-signatureDate", !date); ok = ok && !!date;

      return ok;
    }

    function validateAll(){
      // Clear grouped errors that are not handled in each validate function
      setErr("err-days", false);
      setErr("err-certs", false);
      setErr("err-screening", false);

      return (
        validateBasics() &&
        validateLicense() &&
        validateAvailability() &&
        validateEducation() &&
        validateExperience() &&
        validateResume() &&
        validateScreening() &&
        validateRefs() &&
        validateSignature()
      );
    }

    /* ==========
       Draft save/restore (stores FILE METADATA only)
       ========== */
    function collectDraft(includeFileMeta=true){
      const draft = {
        ts: new Date().toISOString(),
        fields: {},
        cert_none: $("cert_none").checked,
        certs: getChecked("certs"),
        days: getChecked("days"),
        screening: (document.querySelector('input[name="screening"]:checked') || {}).value || "",
        experiences: [],
        references: [],
        files: includeFileMeta ? {
          resume: ($("resume").files?.[0]) ? { name:$("resume").files[0].name, type:$("resume").files[0].type||"unknown", size:$("resume").files[0].size } : null,
          coverLetter: ($("coverLetter").files?.[0]) ? { name:$("coverLetter").files[0].name, type:$("coverLetter").files[0].type||"unknown", size:$("coverLetter").files[0].size } : null,
          licenseDoc: ($("licenseDoc").files?.length ? Array.from($("licenseDoc").files).map(f => ({ name:f.name, type:f.type||"unknown", size:f.size })) : [])
        } : undefined
      };

      const els = document.querySelectorAll("#appForm input, #appForm select, #appForm textarea");
      els.forEach(el => {
        const t = el.type;
        const key = el.name || el.id;
        if (!key) return;
        if (t === "file") return;
        if (t === "checkbox" || t === "radio") return;
        draft.fields[key] = el.value;
      });

      document.querySelectorAll("#expContainer .exp-card").forEach(c => {
        const idx = c.dataset.exp;
        draft.experiences.push({
          employer: $(`exp_employer_${idx}`)?.value || "",
          title: $(`exp_title_${idx}`)?.value || "",
          start: $(`exp_start_${idx}`)?.value || "",
          end: $(`exp_end_${idx}`)?.value || "",
          reason: $(`exp_reason_${idx}`)?.value || "",
          supervisorPhone: $(`exp_supervisorPhone_${idx}`)?.value || "",
          contactOk: $(`exp_contactOk_${idx}`)?.value || ""
        });
      });

      document.querySelectorAll("#refsContainer .ref-card").forEach(c => {
        const idx = c.dataset.ref;
        draft.references.push({
          name: $(`ref_name_${idx}`)?.value || "",
          relation: $(`ref_relation_${idx}`)?.value || "",
          phone: $(`ref_phone_${idx}`)?.value || "",
          email: $(`ref_email_${idx}`)?.value || ""
        });
      });

      draft.fields["consentContactRefs"] = $("consentContactRefs").checked ? "yes" : "";
      draft.fields["consentTruth"] = $("consentTruth").checked ? "yes" : "";
      draft.fields["consentESign"] = $("consentESign").checked ? "yes" : "";

      return draft;
    }

    function applyDraft(draft){
      if (!draft) return;

      const fields = draft.fields || {};
      Object.keys(fields).forEach(k => {
        const el = document.querySelector(`[name="${CSS.escape(k)}"], #${CSS.escape(k)}`);
        if (el && el.type !== "file" && el.type !== "checkbox" && el.type !== "radio"){
          el.value = fields[k];
        }
      });

      $("cert_none").checked = !!draft.cert_none;

      document.querySelectorAll('input[name="certs"]').forEach(cb => {
        cb.checked = (draft.certs || []).includes(cb.value);
      });
      document.querySelectorAll('input[name="days"]').forEach(cb => {
        cb.checked = (draft.days || []).includes(cb.value);
      });

      if (draft.screening){
        const r = document.querySelector(`input[name="screening"][value="${CSS.escape(draft.screening)}"]`);
        if (r) r.checked = true;
      }

      $("consentContactRefs").checked = fields["consentContactRefs"] === "yes";
      $("consentTruth").checked = fields["consentTruth"] === "yes";
      $("consentESign").checked = fields["consentESign"] === "yes";

      $("expContainer").innerHTML = "";
      expCount = 0;
      (draft.experiences || []).forEach(e => $("expContainer").appendChild(makeExpCard(e)));

      $("refsContainer").innerHTML = "";
      refCount = 0;
      (draft.references || []).forEach(r => $("refsContainer").appendChild(makeRefCard(r)));

      // Files cannot be restored (browser security), but we can remind user what was selected.
      if(draft.files){
        // Just show the metadata in the UI lists so user can see everything that was previously selected
        if(draft.files.resume){
          $("resume-list").style.display = "block";
          $("resume-list").innerHTML = `
            <div class="fileitem">
              <div>
                <div style="font-weight:800;">${escapeHtml(draft.files.resume.name)}</div>
                <div class="meta">${escapeHtml(draft.files.resume.type)} • ${bytesToHuman(draft.files.resume.size)}</div>
              </div>
              <div class="meta">Previously selected (re-attach)</div>
            </div>
          `;
        }
        if(draft.files.coverLetter){
          $("cover-list").style.display = "block";
          $("cover-list").innerHTML = `
            <div class="fileitem">
              <div>
                <div style="font-weight:800;">${escapeHtml(draft.files.coverLetter.name)}</div>
                <div class="meta">${escapeHtml(draft.files.coverLetter.type)} • ${bytesToHuman(draft.files.coverLetter.size)}</div>
              </div>
              <div class="meta">Previously selected (re-attach)</div>
            </div>
          `;
        }
        if(Array.isArray(draft.files.licenseDoc) && draft.files.licenseDoc.length){
          $("license-list").style.display = "block";
          $("license-list").innerHTML = draft.files.licenseDoc.map(f => `
            <div class="fileitem">
              <div>
                <div style="font-weight:800;">${escapeHtml(f.name)}</div>
                <div class="meta">${escapeHtml(f.type)} • ${bytesToHuman(f.size)}</div>
              </div>
              <div class="meta">Previously selected (re-attach)</div>
            </div>
          `).join("");
        }
      }
    }

    let autosaveTimer = null;
    function scheduleAutosave(immediate=false){
      // only autosave once they started
      const any = ["firstName","lastName","email","phone"].some(id => String($(id).value||"").trim().length > 0);
      if(!any) return;

      setText($("autosavePill"), immediate ? "Autosave: saving…" : "Autosave: pending…");

      if (autosaveTimer) clearTimeout(autosaveTimer);
      autosaveTimer = setTimeout(() => {
        const draft = collectDraft(true);
        localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
        setText($("draftStatus"), "Yes");
        setText($("autosavePill"), "Autosave: saved");
        toast("Saved", "Your draft has been saved on this device.");
      }, immediate ? 60 : 850);
    }

    $("saveBtn").addEventListener("click", () => scheduleAutosave(true));

    $("toastDownloadBtn").addEventListener("click", () => {
      const draft = collectDraft(true);
      const blob = new Blob([JSON.stringify(draft, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `lpn-application-draft-${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    });

    $("previewBtn").addEventListener("click", () => {
      const draft = collectDraft(true);
      const w = window.open("", "_blank", "noopener,noreferrer,width=900,height=700");
      if(!w) return alert("Pop-up blocked. Please allow pop-ups to preview.");
      w.document.write(`<pre style="white-space:pre-wrap; font:14px/1.4 system-ui, sans-serif; padding:16px;">${escapeHtml(JSON.stringify(draft, null, 2))}</pre>`);
      w.document.close();
    });

    $("resetBtn").addEventListener("click", () => {
      if (!confirm("Clear the form and remove the saved draft on this device?")) return;

      localStorage.removeItem(DRAFT_KEY);
      $("appForm").reset();

      $("expContainer").innerHTML = "";
      $("refsContainer").innerHTML = "";
      expCount = 0;
      refCount = 0;

      // reset file widgets
      setText($("resume-chosen"), "Click to choose resume…");
      setText($("resume-pill"), "No file");
      $("resume-list").style.display = "none"; $("resume-list").innerHTML = "";

      setText($("cover-chosen"), "Click to choose cover letter…");
      setText($("cover-pill"), "Optional");
      $("cover-list").style.display = "none"; $("cover-list").innerHTML = "";

      setText($("license-chosen"), "Click to choose documents…");
      setText($("license-pill"), "Optional");
      $("license-list").style.display = "none"; $("license-list").innerHTML = "";

      $("uploaded-files").style.display = "none";
      $("uploaded-files-items").innerHTML = "";

      setText($("autosavePill"), "Autosave: off");
      setText($("draftStatus"), "No");

      // default cards
      $("expContainer").appendChild(makeExpCard());
      $("refsContainer").appendChild(makeRefCard());
      $("refsContainer").appendChild(makeRefCard());

      updateProgress();
      toast("Cleared", "The form has been cleared.");
    });

    /* ==========
       Progress sidebar
       ========== */
    const requiredIds = [
      "firstName","lastName","email","phone","address1","city","state","zip","startDate",
      "lpnLicenseNumber","lpnLicenseState","lpnLicenseExp",
      "employmentType","shiftPref",
      "school","gradYear",
      "yearsLpn","workAuth",
      "signature","signatureDate"
    ];

    function countCompleteRequired(){
      let complete = 0;
      for (const id of requiredIds){
        const el = $(id);
        if (!el) continue;
        const val = (el.value || "").trim();
        if (val) complete++;
      }

      const anyCert = hasAnyChecked("certs") || $("cert_none").checked;
      const anyDay = hasAnyChecked("days");
      const screening = !!document.querySelector('input[name="screening"]:checked');
      const consentTruth = $("consentTruth").checked;
      const consentESign = $("consentESign").checked;
      const consentRefs = $("consentContactRefs").checked;

      const groupTotal = 6;
      let groupComplete = 0;
      if (anyCert) groupComplete++;
      if (anyDay) groupComplete++;
      if (screening) groupComplete++;
      if (consentTruth) groupComplete++;
      if (consentESign) groupComplete++;
      if (consentRefs) groupComplete++;

      return { complete, total: requiredIds.length, groupComplete, groupTotal };
    }

    function countCompleteRefs(){
      const cards = Array.from(document.querySelectorAll("#refsContainer .ref-card"));
      let complete = 0;
      for (const c of cards){
        const idx = c.dataset.ref;
        const name = $(`ref_name_${idx}`)?.value.trim();
        const rel = $(`ref_relation_${idx}`)?.value.trim();
        const ph = $(`ref_phone_${idx}`)?.value.trim();
        const em = $(`ref_email_${idx}`)?.value.trim();
        if (name && rel && isPhone(ph) && isEmail(em)) complete++;
      }
      return complete;
    }

    function countCompleteExps(){
      const cards = Array.from(document.querySelectorAll("#expContainer .exp-card"));
      let complete = 0;
      for (const c of cards){
        const idx = c.dataset.exp;
        const employer = $(`exp_employer_${idx}`)?.value.trim();
        const title = $(`exp_title_${idx}`)?.value.trim();
        const start = $(`exp_start_${idx}`)?.value;
        const end = $(`exp_end_${idx}`)?.value;
        const reason = $(`exp_reason_${idx}`)?.value.trim();
        const contactOk = $(`exp_contactOk_${idx}`)?.value;
        if (employer && title && start && end && reason && contactOk) complete++;
      }
      return { total: cards.length, complete };
    }

    function updateProgress(){
      const r = countCompleteRequired();
      const total = r.total + r.groupTotal;
      const done = r.complete + r.groupComplete;
      const pct = Math.round((done / total) * 100);
      setText($("reqCount"), `${pct}%`);

      const resumeFile = $("resume").files?.[0] || null;
      setText($("resumeStatus"), resumeFile ? "Yes" : "No");

      setText($("draftStatus"), localStorage.getItem(DRAFT_KEY) ? "Yes" : "No");

      const refsComplete = countCompleteRefs();
      setText($("refsStatus"), `${Math.min(refsComplete, 99)}/2`);

      const exps = countCompleteExps();
      setText($("expStatus"), String(exps.total));

      setText($("filesStatus"), String(countSelectedFiles()));
    }

    document.addEventListener("input", () => { updateProgress(); scheduleAutosave(); });
    document.addEventListener("change", () => { updateProgress(); scheduleAutosave(); });

    /* ==========
       Upload helpers (Storage) + show all uploaded files
       ========== */
    function safeName(name){
      return String(name || "file").replace(/[^a-zA-Z0-9._-]+/g, "_").slice(0, 140);
    }

    async function uploadOneFile(file, path, onProgress){
      return await new Promise((resolve, reject) => {
        const storageRef = sRef(storage, path);
        const task = uploadBytesResumable(storageRef, file, { contentType: file.type || "application/octet-stream" });

        task.on("state_changed", (snap) => {
          const pct = snap.totalBytes ? (snap.bytesTransferred / snap.totalBytes) * 100 : 0;
          onProgress?.(pct);
        }, reject, async () => {
          try{
            const url = await getDownloadURL(task.snapshot.ref);
            resolve({
              name: file.name,
              type: file.type || "unknown",
              size: file.size,
              path,
              url
            });
          }catch(err){ reject(err); }
        });
      });
    }

    function renderUploadedFiles(list){
      if(!Array.isArray(list) || list.length === 0) return;
      $("uploaded-files").style.display = "block";
      const host = $("uploaded-files-items");
      host.innerHTML = "";
      list.forEach(f => {
        const row = document.createElement("div");
        row.className = "fileitem";
        row.innerHTML = `
          <div>
            <div style="font-weight:800;">${escapeHtml(f.name)}</div>
            <div class="meta">${escapeHtml(f.type || "unknown")} • ${bytesToHuman(f.size)}</div>
          </div>
          <div class="meta"><a href="${escapeHtml(f.url)}" target="_blank" rel="noopener noreferrer">Open</a></div>
        `;
        host.appendChild(row);
      });
    }

    /* ==========
       Submission (Firestore + Storage)
       ========== */
    async function submitToFirebase(){
      setSubmitting(true);
      setProgress(5, "Submitting…", "Validating files…");

      // File validation (all selected must be <= 10MB; resume required)
      const resume = $("resume").files?.[0] || null;
      const cover = $("coverLetter").files?.[0] || null;
      const licenseFiles = $("licenseDoc").files ? Array.from($("licenseDoc").files) : [];

      if(!resume){
        setErr("err-resume", true);
        throw new Error("Resume is required.");
      }
      if(!fileOk(resume) || (cover && !fileOk(cover)) || licenseFiles.some(f => !fileOk(f))){
        throw new Error(`One or more files exceed ${MAX_FILE_MB}MB.`);
      }

      // Build application payload (no File objects here)
      const draft = collectDraft(true);

      // Create a Firestore doc first, so we can use its id in storage paths
      setProgress(10, "Submitting…", "Creating application record…");
      const baseDoc = {
        jobTitle: "Licensed Practical Nurse (LPN)",
        company: "Sulandra Community Living Services",
        version: "2.0",
        status: "Pending Review",
        createdAt: serverTimestamp(),
        submittedAtISO: new Date().toISOString(),
        fields: draft.fields,
        cert_none: draft.cert_none,
        certs: draft.certs,
        days: draft.days,
        screening: draft.screening,
        experiences: draft.experiences,
        references: draft.references,
        files: [] // filled after uploads
      };

      const docRef = await addDoc(collection(db, "applications_lpn"), baseDoc);
      const appId = docRef.id;

      // Upload files
      const uploaded = [];
      const all = [
        { key:"resume", file: resume, bucket:"resume" },
        { key:"coverLetter", file: cover, bucket:"cover-letter" },
        ...licenseFiles.map((f, i) => ({ key:`licenseDoc_${i+1}`, file:f, bucket:"license-docs" }))
      ].filter(x => !!x.file);

      // Spread progress between 15% and 90%
      let fileIndex = 0;
      const startPct = 15;
      const endPct = 90;

      for(const item of all){
        fileIndex++;
        const pctBase = startPct + ((fileIndex - 1) / all.length) * (endPct - startPct);
        const pctSpan = (endPct - startPct) / all.length;

        const path = `applications_lpn/${appId}/${item.bucket}/${Date.now()}_${safeName(item.file.name)}`;

        setProgress(pctBase, "Uploading files…", `${fileIndex}/${all.length}: ${item.file.name}`);

        const meta = await uploadOneFile(item.file, path, (p) => {
          setProgress(pctBase + (p/100)*pctSpan, "Uploading files…", `${fileIndex}/${all.length}: ${item.file.name}`);
        });

        uploaded.push({ ...meta, field: item.key });
      }

      // Save final submission with uploaded file links (write a second doc in same collection as a new record is not ideal,
      // but we avoid needing updateDoc permissions. If you want single doc updates, change rules + use updateDoc here.)
      // ✅ Better: write a second document to an "applications_lpn_submissions" collection that references appId.
      setProgress(92, "Finalizing…", "Saving uploaded file links…");
      await addDoc(collection(db, "applications_lpn_submissions"), {
        applicationId: appId,
        createdAt: serverTimestamp(),
        submittedAtISO: new Date().toISOString(),
        uploadedFiles: uploaded
      });

      setProgress(100, "Submitted!", "Thank you — we received your application.");
      return { appId, uploaded };
    }

    /* ==========
       Form submit
       ========== */
    $("appForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      // reset any visible error blocks that are purely grouped
      setErr("err-resume", false);

      const ok = validateAll();
      if (!ok){
        toast("Please fix errors", "Some required fields are missing or invalid.");
        const first = document.querySelector(".error.show");
        if (first) first.scrollIntoView({behavior:"smooth", block:"center"});
        return;
      }

      try{
        const { appId, uploaded } = await submitToFirebase();

        // Show uploaded files on page (so applicant can see everything that was submitted)
        renderUploadedFiles(uploaded);

        // Clear draft + reset autosave
        localStorage.removeItem(DRAFT_KEY);
        setText($("draftStatus"), "No");
        setText($("autosavePill"), "Autosave: off");

        toast("Submitted", `Application received. Confirmation ID: ${appId}`);

        // OPTIONAL: redirect after a moment (comment out if you want to keep them on page)
        // window.location.href = "/Careers.html";

      } catch(err){
        console.error(err);
        setSubmitting(false);
        setProgress(0, "Submission error", "Please try again.");
        toast("Submission error", err?.message || "Please check your internet and try again.");
      } finally {
        setSubmitting(false);
      }
    });

    /* ==========
       Init
       ========== */
    (function init(){
      // default signature date = today
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth()+1).padStart(2,'0');
      const dd = String(today.getDate()).padStart(2,'0');
      if(!$("signatureDate").value) $("signatureDate").value = `${yyyy}-${mm}-${dd}`;

      // restore draft
      const saved = localStorage.getItem(DRAFT_KEY);
      if (saved){
        try{
          applyDraft(JSON.parse(saved));
          setText($("autosavePill"), "Autosave: loaded");
          setText($("draftStatus"), "Yes");
          toast("Draft loaded", "We restored a saved draft from this device. You may need to re-attach files.");
        }catch(_){}
      }

      // ensure at least one exp and two refs
      if (document.querySelectorAll("#expContainer .exp-card").length === 0){
        $("expContainer").appendChild(makeExpCard());
      }
      if (document.querySelectorAll("#refsContainer .ref-card").length === 0){
        $("refsContainer").appendChild(makeRefCard());
        $("refsContainer").appendChild(makeRefCard());
      }

      updateProgress();
    })();
  </script>
</body>
</html>
