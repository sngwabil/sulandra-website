<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sulandra Admin | Application Manager</title>
  <meta name="description" content="Admin dashboard to review applications, view details + uploaded file links, and hire applicants into employee profiles." />

  <style>
    :root{
      --bg:#f6f7f8;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --border:#d1d5db;

      --primary:#004b8d;
      --secondary:#0077c8;
      --accent:#d14124;

      --shadow: 0 6px 18px rgba(0,0,0,.08);
      --radius: 14px;

      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--text); }
    a{ color:inherit; }
    .wrap{ max-width: 1200px; margin: 0 auto; padding: 18px 16px; }

    .alert-bar{
      background: var(--accent);
      color:#fff;
      text-align:center;
      padding:10px 20px;
      font-size:14px;
      font-weight:800;
    }

    header{
      position:sticky;
      top:0;
      z-index:1000;
      background:#fff;
      border-bottom:1px solid #ddd;
    }
    .top-nav{
      max-width:1200px;
      margin:0 auto;
      padding:15px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    .logo{ display:flex; align-items:center; gap:12px; min-width:0; }
    .logo img{ width:240px; height:auto; object-fit:contain; }
    .hdr-right{
      display:flex; gap:12px; align-items:center;
      font-weight:800; font-size:13px; color:var(--muted);
      white-space:nowrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-size:12px; font-weight:750; color:var(--muted);
      white-space:nowrap;
    }
    .btn{
      border:0; cursor:pointer;
      border-radius:12px;
      padding:10px 14px;
      font-weight:900;
      font-size:13px;
      transition: filter .2s ease, transform .05s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{ background:var(--primary); color:#fff; }
    .btn-primary:hover{ filter:brightness(.95); }
    .btn-ghost{
      background:transparent;
      border:1px solid var(--border);
      color:var(--text);
    }
    .btn-ghost:hover{ background:#f9fafb; }
    .btn-danger{
      background:#fee2e2;
      color:#7f1d1d;
      border:1px solid #fecaca;
    }
    .btn-sm{ padding:8px 10px; border-radius:10px; font-size:12px; }
    .btn-view{ background:var(--secondary); color:#fff; }
    .btn-hire{ background:#166534; color:#fff; }
    .btn-disabled{ opacity:.55; cursor:not-allowed; }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
      margin-top:16px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
    }
    h1{ margin:0 0 6px; color:var(--primary); font-size:20px; }
    .sub{ margin:0; color:var(--muted); font-size:13px; }

    .toolbar{
      margin-top:14px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .filters{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .field{
      display:flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--border);
      border-radius:12px;
      padding:8px 10px;
      background:#fff;
    }
    .field label{
      font-size:12px;
      font-weight:850;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.4px;
    }
    input[type="search"], input[type="text"], select{
      border:0;
      outline:none;
      background:transparent;
      font-size:13px;
      min-width: 180px;
    }
    select{ min-width: 160px; }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:14px;
      background:#fff;
      border:1px solid rgba(209,213,219,.7);
      border-radius:12px;
      overflow:hidden;
    }
    thead th{
      text-align:left;
      padding:12px;
      background:#edf2f7;
      color:#4a5568;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.4px;
    }
    tbody td{
      padding:12px;
      border-bottom:1px solid #edf2f7;
      font-size:13px;
      vertical-align:top;
    }
    tbody tr:hover{ background:#fbfdff; }
    .muted{ color:var(--muted); }

    .status-pill{
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:900;
      display:inline-block;
      border:1px solid rgba(209,213,219,.7);
    }
    .Pending { background:#fef3c7; color:#92400e; border-color:#f59e0b33; }
    .Reviewed { background:#e0f2fe; color:#075985; border-color:#0284c733; }
    .Hired { background:#dcfce7; color:#166534; border-color:#22c55e33; }
    .Rejected { background:#fee2e2; color:#7f1d1d; border-color:#ef444433; }

    .score{
      font-weight:900;
      padding:4px 8px;
      border-radius:10px;
      border:1px solid rgba(209,213,219,.7);
      display:inline-block;
      min-width: 62px;
      text-align:center;
      background:#fff;
    }

    /* Modal */
    #detailsModal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      z-index:1000;
      padding:16px;
    }
    .modal{
      background:#fff;
      max-width: 920px;
      margin: 24px auto;
      border-radius: 16px;
      border:1px solid rgba(209,213,219,.7);
      box-shadow: var(--shadow);
      overflow:hidden;
      max-height: calc(100vh - 48px);
      display:flex;
      flex-direction:column;
    }
    .modal-head{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid rgba(209,213,219,.7);
      background:#fcfcfd;
    }
    .modal-title{
      font-weight:950;
      font-size:14px;
      color:var(--text);
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .modal-body{
      padding:16px;
      overflow:auto;
    }
    .close-x{
      font-size:22px;
      line-height:1;
      cursor:pointer;
      padding:6px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
    }
    .close-x:hover{ background:#f9fafb; }

    .kvgrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    @media (max-width: 820px){ .kvgrid{ grid-template-columns: 1fr; } }

    .kv{
      border:1px solid rgba(209,213,219,.7);
      border-radius:14px;
      padding:12px;
      background:#fff;
    }
    .kv .k{
      font-size:11px;
      font-weight:900;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.4px;
      margin-bottom:6px;
    }
    .kv .v{
      font-size:13px;
      font-weight:800;
      word-break:break-word;
    }

    .section{
      margin-top:14px;
      border-top:1px dashed rgba(209,213,219,.9);
      padding-top:14px;
    }
    .section h3{
      margin:0 0 8px;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.5px;
      color:var(--primary);
    }
    .list{
      border:1px solid rgba(209,213,219,.7);
      border-radius:14px;
      overflow:hidden;
    }
    .list .rowi{
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border-bottom:1px solid rgba(209,213,219,.55);
      font-size:13px;
      background:#fff;
    }
    .list .rowi:last-child{ border-bottom:0; }
    .list .rowi .meta{ color:var(--muted); font-weight:700; }
    .list a{ color:var(--secondary); font-weight:900; }

    .toast{
      position: fixed;
      right: 16px; bottom: 16px;
      width: min(420px, calc(100vw - 32px));
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 14px;
      display:none;
      z-index: 1500;
    }
    .toast.show{ display:block; }
    .toast strong{ display:block; margin-bottom:4px; }
    .toast small{ color: var(--muted); }

    .tiny{ font-size:12px; color:var(--muted); }
  </style>
</head>

<body>
  <div class="alert-bar">Admin Console — confidential. Authorized staff only.</div>

  <header>
    <div class="top-nav">
      <a href="/index.html" class="logo" aria-label="Sulandra Health Home">
        <img src="/assets/mainlogo.png" alt="Sulandra Health Logo" />
      </a>

      <div class="hdr-right">
        <span class="pill" id="livePill">Live: connecting…</span>
        <button class="btn btn-ghost btn-sm" id="refreshBtn" type="button">Refresh</button>
        <button class="btn btn-primary btn-sm" id="exportBtn" type="button">Export CSV</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <!-- Applicant Management -->
      <section class="card">
        <h1>Applicant Management</h1>
        <p class="sub">Review applications, view uploaded documents, update status, and hire candidates to generate employee profiles.</p>

        <div class="toolbar">
          <div class="filters">
            <div class="field">
              <label for="search">Search</label>
              <input id="search" type="search" placeholder="Name, email, phone…" />
            </div>

            <div class="field">
              <label for="statusFilter">Status</label>
              <select id="statusFilter">
                <option value="all">All</option>
                <option value="Pending">Pending</option>
                <option value="Reviewed">Reviewed</option>
                <option value="Hired">Hired</option>
                <option value="Rejected">Rejected</option>
              </select>
            </div>

            <div class="field">
              <label for="jobFilter">Job</label>
              <select id="jobFilter">
                <option value="all">All</option>
                <option value="LPN">LPN</option>
                <option value="DSP">DSP</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>

          <div class="tiny" id="countLabel">0 applications</div>
        </div>

        <table aria-label="Applications table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Applicant</th>
              <th>Job</th>
              <th>Score</th>
              <th>Status</th>
              <th style="width:260px;">Actions</th>
            </tr>
          </thead>
          <tbody id="applicantTable">
            <tr><td colspan="6" class="muted">Loading applications…</td></tr>
          </tbody>
        </table>
      </section>

      <!-- Education Assignment -->
      <section class="card" style="margin-top:20px;">
        <h1>Education Assignment</h1>
        <p class="sub">Select a hired employee and assign training modules to their portal.</p>

        <div class="toolbar">
          <div class="filters">
            <div class="field">
              <label for="employeeSelect">Employee</label>
              <select id="employeeSelect"><option>Loading employees...</option></select>
            </div>
            <div class="field">
              <label for="trainingInput">Training Name</label>
              <input id="trainingInput" type="text" placeholder="e.g., HIPAA 2025">
            </div>
            <button class="btn btn-primary" id="assignBtn" type="button">Assign Education</button>
            <span class="tiny" id="assignHint"></span>
          </div>
        </div>
      </section>

      <!-- Timesheet Review & Payroll -->
      <section class="card" style="margin-top:20px;">
        <h1>Timesheet Review & Payroll</h1>
        <p class="sub">Approve weekly hours. Approved entries will be marked for payroll processing.</p>

        <table aria-label="Timesheets table">
          <thead>
            <tr>
              <th>Employee</th>
              <th>Week Ending</th>
              <th>Hours</th>
              <th>Pay Code</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="timesheetTable">
            <tr><td colspan="6" class="muted">Loading timesheets…</td></tr>
          </tbody>
        </table>
      </section>
    </div>
  </main>

  <!-- Details Modal -->
  <div id="detailsModal" role="dialog" aria-modal="true" aria-label="Application details">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title" id="modalTitle">Application</div>
        <button class="close-x" id="closeModalBtn" type="button" aria-label="Close">×</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite">
    <strong id="toastTitle">Done</strong>
    <small id="toastBody">OK</small>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      onSnapshot,
      doc,
      updateDoc,
      setDoc,
      addDoc,
      getDoc,
      query,
      orderBy,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCi3Qtyka_PJsHT9Ln7LJZp2BCqOxW3lM8",
      authDomain: "sulandra-health-portal.firebaseapp.com",
      projectId: "sulandra-health-portal",
      storageBucket: "sulandra-health-portal.firebasestorage.app",
      messagingSenderId: "547316167712",
      appId: "1:547316167712:web:24dfc2c5bd9d0296b4f845"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ==========
       Helpers
       ========== */
    const $ = (id) => document.getElementById(id);

    function toast(title, body){
      $("toastTitle").textContent = title;
      $("toastBody").textContent = body || "";
      $("toast").classList.add("show");
      setTimeout(() => $("toast").classList.remove("show"), 2600);
    }

    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function fmtDate(iso){
      if(!iso) return "N/A";
      try{
        const d = new Date(iso);
        if(Number.isNaN(d.getTime())) return String(iso).split("T")[0] || "N/A";
        return d.toISOString().split("T")[0];
      }catch(_){
        return String(iso).split("T")[0] || "N/A";
      }
    }

    function guessJobLabel(app){
      const jt = (app.jobTitle || app.fields?.jobTitle || "").toString().toLowerCase();
      if(jt.includes("practical") || jt.includes("lpn")) return "LPN";
      if(jt.includes("dsp") || jt.includes("direct support")) return "DSP";
      return jt ? "Other" : "—";
    }

    function getApplicantName(app){
      const fn = app.firstName || app.fields?.firstName || "";
      const ln = app.lastName || app.fields?.lastName || "";
      const combined = `${fn} ${ln}`.trim();
      return combined || "Unknown";
    }

    function getApplicantEmail(app){
      return app.email || app.fields?.email || "—";
    }

    function getApplicantPhone(app){
      return app.phone || app.fields?.phone || "—";
    }

    function getStatus(app){
      return (app.status || "Pending").toString();
    }

    function getScore(app){
      const a = app.assessment?.score;
      if(typeof a === "number") return a;
      const b = app.fields?.assessmentScore;
      const n = Number(b);
      return Number.isFinite(n) ? n : 0;
    }

    function normalizeAppRecord(docId, data, source){
      return {
        id: docId,
        source,
        ...data
      };
    }

    function downloadText(filename, text){
      const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function toCSV(rows){
      const esc = (v) => `"${String(v ?? "").replaceAll('"', '""')}"`;
      const header = ["date","name","email","phone","job","status","score","collection","id"];
      const lines = [header.join(",")];
      for(const r of rows){
        lines.push([
          esc(r.date),
          esc(r.name),
          esc(r.email),
          esc(r.phone),
          esc(r.job),
          esc(r.status),
          esc(r.score),
          esc(r.collection),
          esc(r.id)
        ].join(","));
      }
      return lines.join("\n");
    }

    /* ==========
       Applications (existing)
       ========== */
    const collectionsToWatch = [
      { key:"applications_lpn", label:"applications_lpn" },
      { key:"applications", label:"applications" } // legacy
    ];
    const submissionsCollection = { key:"applications_lpn_submissions", label:"applications_lpn_submissions" };

    let apps = [];
    let rawApps = [];
    let submissions = [];
    let unsubscribers = [];

    function setLiveState(text){
      $("livePill").textContent = text;
    }

    function stopSnapshots(){
      unsubscribers.forEach(fn => { try{ fn(); }catch(_){} });
      unsubscribers = [];
    }

    function startSnapshots(){
      stopSnapshots();
      setLiveState("Live: connected");

      for(const c of collectionsToWatch){
        const qy = query(collection(db, c.key), orderBy("submittedAtISO", "desc"));
        const unsub = onSnapshot(qy, (snap) => {
          const next = [];
          snap.forEach(d => next.push(normalizeAppRecord(d.id, d.data(), c.key)));
          rawApps = rawApps.filter(x => x.source !== c.key).concat(next);
          rebuildMerged();
          render();
        }, (err) => {
          console.error(err);
          setLiveState("Live: error");
          toast("Live error", "Could not load applications.");
        });
        unsubscribers.push(unsub);
      }

      const qsub = query(collection(db, submissionsCollection.key), orderBy("submittedAtISO", "desc"));
      const unsubSub = onSnapshot(qsub, (snap) => {
        const next = [];
        snap.forEach(d => next.push(normalizeAppRecord(d.id, d.data(), submissionsCollection.key)));
        submissions = next;
        rebuildMerged();
        render();
      }, (err) => {
        console.error(err);
      });
      unsubscribers.push(unsubSub);
    }

    function findUploadedFilesFor(appId){
      const s = submissions.find(x => x.applicationId === appId);
      if(s && Array.isArray(s.uploadedFiles)) return s.uploadedFiles;

      const base = rawApps.find(x => x.id === appId && (x.source === "applications"));
      if(base && Array.isArray(base.uploadedFiles)) return base.uploadedFiles;

      const base2 = rawApps.find(x => x.id === appId);
      if(base2 && Array.isArray(base2.files)) return base2.files;

      return [];
    }

    function rebuildMerged(){
      apps = rawApps
        .filter(x => x.source !== submissionsCollection.key)
        .map(x => {
          const dateISO = x.submittedAtISO || x.fields?.submittedAtISO || "";
          const status = getStatus(x);
          const name = getApplicantName(x);
          const email = getApplicantEmail(x);
          const phone = getApplicantPhone(x);
          const job = guessJobLabel(x);
          const score = getScore(x);
          const uploadedFiles = findUploadedFilesFor(x.id);

          return {
            id: x.id,
            collection: x.source,
            dateISO,
            date: fmtDate(dateISO),
            name,
            email,
            phone,
            job,
            status,
            score,
            uploadedFiles,
            raw: x
          };
        })
        .sort((a,b) => (b.dateISO || "").localeCompare(a.dateISO || ""));
    }

    function getFiltered(){
      const q = ($("search").value || "").trim().toLowerCase();
      const status = $("statusFilter").value;
      const job = $("jobFilter").value;

      return apps.filter(a => {
        const matchesQ = !q || (
          a.name.toLowerCase().includes(q) ||
          String(a.email).toLowerCase().includes(q) ||
          String(a.phone).toLowerCase().includes(q)
        );

        const matchesStatus = (status === "all") || (a.status === status);
        const matchesJob = (job === "all") || (a.job === job);

        return matchesQ && matchesStatus && matchesJob;
      });
    }

    function render(){
      const tbody = $("applicantTable");
      const rows = getFiltered();

      $("countLabel").textContent = `${rows.length} application${rows.length === 1 ? "" : "s"}`;

      if(rows.length === 0){
        tbody.innerHTML = `<tr><td colspan="6" class="muted">No applications match your filters.</td></tr>`;
        return;
      }

      tbody.innerHTML = "";
      for(const a of rows){
        const tr = document.createElement("tr");

        const hireBtn = (a.status !== "Hired")
          ? `<button class="btn btn-sm btn-hire" data-action="hire" data-id="${escapeHtml(a.id)}" data-col="${escapeHtml(a.collection)}">HIRE</button>`
          : `<button class="btn btn-sm btn-ghost btn-disabled" type="button" disabled>HIRED</button>`;

        tr.innerHTML = `
          <td>${escapeHtml(a.date)}</td>
          <td>
            <div style="font-weight:950;">${escapeHtml(a.name)}</div>
            <div class="muted" style="font-size:12px;">${escapeHtml(a.email)}</div>
          </td>
          <td>
            <div style="font-weight:900;">${escapeHtml(a.job)}</div>
            <div class="muted" style="font-size:12px;">${escapeHtml(a.collection)}</div>
          </td>
          <td><span class="score">${escapeHtml(String(a.score))}/10</span></td>
          <td><span class="status-pill ${escapeHtml(a.status)}">${escapeHtml(a.status)}</span></td>
          <td>
            <button class="btn btn-sm btn-view" data-action="view" data-id="${escapeHtml(a.id)}" data-col="${escapeHtml(a.collection)}">View Details</button>
            <button class="btn btn-sm btn-ghost" data-action="status" data-id="${escapeHtml(a.id)}" data-col="${escapeHtml(a.collection)}">Update Status</button>
            ${hireBtn}
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    /* ==========
       Modal
       ========== */
    function openModal(){ $("detailsModal").style.display = "block"; }
    function closeModal(){ $("detailsModal").style.display = "none"; }

    $("closeModalBtn").addEventListener("click", closeModal);
    $("detailsModal").addEventListener("click", (e) => { if(e.target === $("detailsModal")) closeModal(); });
    document.addEventListener("keydown", (e) => { if(e.key === "Escape") closeModal(); });

    async function viewApplication(appId, sourceCollection){
      const baseRef = doc(db, sourceCollection, appId);
      const snap = await getDoc(baseRef);
      if(!snap.exists()){
        toast("Not found", "Application could not be loaded.");
        return;
      }
      const data = snap.data();
      const row = apps.find(x => x.id === appId && x.collection === sourceCollection) || null;

      const name = getApplicantName(data);
      const email = getApplicantEmail(data);
      const phone = getApplicantPhone(data);
      const status = getStatus(data);
      const job = data.jobTitle || data.fields?.jobTitle || "—";

      const fields = data.fields || {};
      const address = [
        fields.address1 || data.address1 || "",
        fields.address2 || data.address2 || "",
        fields.city || data.city || "",
        fields.state || data.state || "",
        fields.zip || data.zip || ""
      ].filter(Boolean).join(", ") || "—";

      const experiences = data.experiences || data.fields?.experiences || row?.raw?.experiences || [];
      const references = data.references || data.fields?.references || row?.raw?.references || [];

      const uploadedFiles = row ? row.uploadedFiles : findUploadedFilesFor(appId);

      let filesHtml = "";
      if(uploadedFiles && uploadedFiles.length){
        const items = uploadedFiles.map(f => {
          const url = f.url || f.downloadURL || "";
          const label = f.field || f.label || "File";
          const nm = f.name || "document";
          const meta = [f.type, (typeof f.size === "number" ? `${Math.round(f.size/1024)} KB` : "")].filter(Boolean).join(" • ");
          return `
            <div class="rowi">
              <div>
                <div style="font-weight:900;">${escapeHtml(label)}: ${escapeHtml(nm)}</div>
                <div class="meta">${escapeHtml(meta || "Uploaded")}</div>
              </div>
              <div class="meta">
                ${url ? `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">Open</a>` : "—"}
              </div>
            </div>
          `;
        }).join("");

        filesHtml = `
          <div class="section">
            <h3>Uploaded Documents</h3>
            <div class="list">${items}</div>
          </div>
        `;
      }else{
        filesHtml = `
          <div class="section">
            <h3>Uploaded Documents</h3>
            <div class="list"><div class="rowi"><div class="meta">No uploaded files found.</div><div class="meta">—</div></div></div>
          </div>
        `;
      }

      const expHtml = Array.isArray(experiences) && experiences.length ? experiences.map((e,i) => `
        <div class="rowi">
          <div>
            <div style="font-weight:900;">#${i+1} ${escapeHtml(e.title || "")} ${e.employer ? "— " + escapeHtml(e.employer) : ""}</div>
            <div class="meta">${escapeHtml((e.start || "—") + " → " + (e.end || "—"))}</div>
          </div>
          <div class="meta">${escapeHtml(e.contactOk ? "Contact: " + e.contactOk : "")}</div>
        </div>
      `).join("") : `<div class="rowi"><div class="meta">No experience entries.</div><div class="meta">—</div></div>`;

      const refHtml = Array.isArray(references) && references.length ? references.map((r,i) => `
        <div class="rowi">
          <div>
            <div style="font-weight:900;">#${i+1} ${escapeHtml(r.name || "")} ${r.relation ? "— " + escapeHtml(r.relation) : ""}</div>
            <div class="meta">${escapeHtml((r.email || "—") + " • " + (r.phone || "—"))}</div>
          </div>
          <div class="meta">—</div>
        </div>
      `).join("") : `<div class="rowi"><div class="meta">No references.</div><div class="meta">—</div></div>`;

      const certs = data.certs || fields.certs || [];
      const days = data.days || fields.days || [];
      const statement = fields.why || data.why || "—";

      $("modalTitle").innerHTML = `
        ${escapeHtml(name)}
        <span class="status-pill ${escapeHtml(status)}">${escapeHtml(status)}</span>
        <span class="pill">ID: ${escapeHtml(appId)}</span>
      `;

      $("modalBody").innerHTML = `
        <div class="kvgrid">
          <div class="kv"><div class="k">Email</div><div class="v">${escapeHtml(email)}</div></div>
          <div class="kv"><div class="k">Phone</div><div class="v">${escapeHtml(phone)}</div></div>
          <div class="kv"><div class="k">Job Title</div><div class="v">${escapeHtml(job)}</div></div>
          <div class="kv"><div class="k">Address</div><div class="v">${escapeHtml(address)}</div></div>
          <div class="kv"><div class="k">Certs</div><div class="v">${escapeHtml(Array.isArray(certs) ? certs.join(", ") : String(certs || "—"))}</div></div>
          <div class="kv"><div class="k">Days Available</div><div class="v">${escapeHtml(Array.isArray(days) ? days.join(", ") : String(days || "—"))}</div></div>
        </div>

        <div class="section">
          <h3>Applicant Statement</h3>
          <div class="kv"><div class="v" style="font-weight:650;">${escapeHtml(statement)}</div></div>
        </div>

        <div class="section">
          <h3>Work Experience</h3>
          <div class="list">${expHtml}</div>
        </div>

        <div class="section">
          <h3>References</h3>
          <div class="list">${refHtml}</div>
        </div>

        ${filesHtml}

        <div class="section">
          <h3>Quick Actions</h3>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn btn-view btn-sm" id="modalMarkReviewed">Mark Reviewed</button>
            <button class="btn btn-danger btn-sm" id="modalMarkRejected">Reject</button>
            <button class="btn btn-hire btn-sm" id="modalHire">Hire</button>
          </div>
          <div class="tiny" style="margin-top:8px;">Hiring creates a record in <code>employees</code> and sets application status to <strong>Hired</strong>.</div>
        </div>
      `;

      $("modalMarkReviewed").addEventListener("click", () => updateStatus(appId, sourceCollection, "Reviewed", true));
      $("modalMarkRejected").addEventListener("click", () => updateStatus(appId, sourceCollection, "Rejected", true));
      $("modalHire").addEventListener("click", () => hireEmployee(appId, sourceCollection, true));

      openModal();
    }

    /* ==========
       Status update + Hire
       ========== */
    async function updateStatus(appId, sourceCollection, status, keepOpen=false){
      try{
        await updateDoc(doc(db, sourceCollection, appId), {
          status,
          statusUpdatedAt: serverTimestamp()
        });
        toast("Updated", `Status set to ${status}.`);
        if(!keepOpen) closeModal();
      }catch(err){
        console.error(err);
        toast("Update failed", "Check permissions / Firestore rules.");
      }
    }

    async function hireEmployee(appId, sourceCollection, keepOpen=false){
      try{
        const empId = prompt("Enter the new Employee ID (e.g., SCLS-101):");
        if (!empId) return;

        const baseRef = doc(db, sourceCollection, appId);
        const snap = await getDoc(baseRef);
        if(!snap.exists()){
          toast("Not found", "Application could not be loaded.");
          return;
        }
        const appData = snap.data();
        const fields = appData.fields || {};

        await setDoc(doc(db, "employees", empId), {
          employeeId: empId,
          firstName: appData.firstName || fields.firstName || "",
          lastName: appData.lastName || fields.lastName || "",
          email: appData.email || fields.email || "",
          phone: appData.phone || fields.phone || "",
          hiredDate: new Date().toISOString(),
          status: "Active",
          assignedEducation: [],
          role: appData.jobTitle || fields.jobTitle || guessJobLabel(appData) || "Employee",
          sourceApplicationId: appId,
          sourceCollection
        }, { merge: true });

        await updateDoc(baseRef, { status: "Hired", hiredEmployeeId: empId, hiredAt: serverTimestamp() });

        toast("Hired", `Employee profile created: ${empId}`);
        if(!keepOpen) closeModal();
      }catch(err){
        console.error(err);
        toast("Hire failed", "Check permissions / Firestore rules.");
      }
    }

    /* ==========
       Applicant table actions
       ========== */
    $("applicantTable").addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-action]");
      if(!btn) return;

      const action = btn.dataset.action;
      const id = btn.dataset.id;
      const col = btn.dataset.col;

      if(action === "view") viewApplication(id, col);
      if(action === "status"){
        const current = apps.find(x => x.id === id && x.collection === col)?.status || "Pending";
        const next = prompt("Set status to: Pending, Reviewed, Hired, Rejected", current);
        if(!next) return;
        const allowed = ["Pending","Reviewed","Hired","Rejected"];
        if(!allowed.includes(next)){
          toast("Invalid status", "Use: Pending, Reviewed, Hired, Rejected");
          return;
        }
        updateStatus(id, col, next);
      }
      if(action === "hire") hireEmployee(id, col);
    });

    /* ==========
       Filters
       ========== */
    ["search","statusFilter","jobFilter"].forEach(id => {
      $(id).addEventListener("input", render);
      $(id).addEventListener("change", render);
    });

    /* ==========
       Buttons
       ========== */
    $("refreshBtn").addEventListener("click", () => {
      toast("Refreshing", "Reconnecting to live updates…");
      startSnapshots();
      startEmployeesSnapshot();
      startTimesheetsSnapshot();
    });

    $("exportBtn").addEventListener("click", () => {
      const rows = getFiltered().map(a => ({
        date: a.date,
        name: a.name,
        email: a.email,
        phone: a.phone,
        job: a.job,
        status: a.status,
        score: a.score,
        collection: a.collection,
        id: a.id
      }));
      downloadText(`applications-export-${new Date().toISOString().slice(0,10)}.csv`, toCSV(rows));
      toast("Exported", "CSV downloaded.");
    });

    /* ==========
       Education Assignment
       ==========
       - Reads employees collection
       - Assigns training by appending to assignedEducation array AND
         optionally writing an educationAssignments collection (audit log)
       ========== */
    let employees = [];

    function renderEmployeeSelect(){
      const sel = $("employeeSelect");
      if(!sel) return;

      // only show Active employees by default, but keep everything if you want
      const opts = employees.slice().sort((a,b) => (a.lastName||"").localeCompare(b.lastName||""));

      if(opts.length === 0){
        sel.innerHTML = `<option value="">No employees found</option>`;
        return;
      }

      sel.innerHTML = `<option value="">Select…</option>` + opts.map(e => {
        const id = e.employeeId || e.id;
        const name = `${e.firstName || ""} ${e.lastName || ""}`.trim() || "Employee";
        const role = e.role || "";
        return `<option value="${escapeHtml(String(id))}">${escapeHtml(`${name} (${id})${role ? " — " + role : ""}`)}</option>`;
      }).join("");
    }

    function startEmployeesSnapshot(){
      const qemp = query(collection(db, "employees"), orderBy("lastName", "asc"));
      const unsub = onSnapshot(qemp, (snap) => {
        const next = [];
        snap.forEach(d => next.push({ id: d.id, ...d.data() }));
        employees = next;
        renderEmployeeSelect();
      }, (err) => {
        console.error(err);
        $("employeeSelect").innerHTML = `<option value="">Employees load error</option>`;
      });
      unsubscribers.push(unsub);
    }

    async function assignEducation(){
      const empId = $("employeeSelect").value;
      const training = ($("trainingInput").value || "").trim();
      const hint = $("assignHint");

      if(hint) hint.textContent = "";

      if(!empId){
        toast("Select employee", "Choose an employee first.");
        return;
      }
      if(!training){
        toast("Training required", "Enter a training name.");
        return;
      }

      try{
        // Update employee document (assignedEducation = [{name,assignedAtISO,status}])
        const empRef = doc(db, "employees", empId);
        const empSnap = await getDoc(empRef);
        if(!empSnap.exists()){
          toast("Not found", "Employee record not found.");
          return;
        }
        const empData = empSnap.data() || {};
        const current = Array.isArray(empData.assignedEducation) ? empData.assignedEducation : [];

        // Prevent duplicates by name (case-insensitive)
        const exists = current.some(x => (x?.name || "").toLowerCase() === training.toLowerCase());
        if(exists){
          toast("Already assigned", "That training is already assigned to this employee.");
          return;
        }

        const entry = {
          name: training,
          status: "Assigned",
          assignedAtISO: new Date().toISOString()
        };

        await updateDoc(empRef, {
          assignedEducation: [...current, entry],
          educationUpdatedAt: serverTimestamp()
        });

        // Optional audit log (nice for admin history)
        await addDoc(collection(db, "educationAssignments"), {
          employeeId: empId,
          trainingName: training,
          createdAt: serverTimestamp(),
          createdAtISO: new Date().toISOString(),
          status: "Assigned"
        });

        $("trainingInput").value = "";
        if(hint) hint.textContent = "Assigned!";
        toast("Assigned", `Education assigned to ${empId}.`);
      }catch(err){
        console.error(err);
        toast("Assign failed", "Check Firestore rules / permissions.");
      }
    }

    $("assignBtn").addEventListener("click", assignEducation);

    /* ==========
       Timesheet Review & Payroll
       ==========
       Assumes a collection: "timesheets"
       Expected fields (flexible):
         - employeeId, employeeName (optional), weekEndingISO, hours, payCode
         - status: Pending | Approved | Rejected
       Approve marks status=Approved and payrollReady=true
       ========== */
    let timesheets = [];

    function getTimesheetStatus(t){
      return (t.status || "Pending").toString();
    }

    function renderTimesheets(){
      const tbody = $("timesheetTable");
      if(!tbody) return;

      const pending = timesheets
        .filter(t => getTimesheetStatus(t) !== "Approved") // show pending/rejected; adjust if you want ONLY pending
        .sort((a,b) => (b.weekEndingISO || "").localeCompare(a.weekEndingISO || ""));

      if(pending.length === 0){
        tbody.innerHTML = `<tr><td colspan="6" class="muted">No pending timesheets.</td></tr>`;
        return;
      }

      tbody.innerHTML = "";
      for(const t of pending){
        const tr = document.createElement("tr");
        const employeeLabel =
          t.employeeName ||
          (employees.find(e => (e.employeeId || e.id) === t.employeeId)?.firstName
            ? `${employees.find(e => (e.employeeId || e.id) === t.employeeId).firstName} ${employees.find(e => (e.employeeId || e.id) === t.employeeId).lastName}`
            : t.employeeId || "—");

        const status = getTimesheetStatus(t);

        tr.innerHTML = `
          <td><strong>${escapeHtml(employeeLabel)}</strong><div class="muted" style="font-size:12px;">${escapeHtml(t.employeeId || "")}</div></td>
          <td>${escapeHtml(fmtDate(t.weekEndingISO || t.weekEnding || t.weekEndingDate))}</td>
          <td>${escapeHtml(String(t.hours ?? t.totalHours ?? "—"))}</td>
          <td>${escapeHtml(String(t.payCode ?? "REG"))}</td>
          <td><span class="status-pill ${escapeHtml(status)}">${escapeHtml(status)}</span></td>
          <td>
            <button class="btn btn-sm btn-primary" data-ts-action="approve" data-id="${escapeHtml(t.id)}">Approve</button>
            <button class="btn btn-sm btn-danger" data-ts-action="reject" data-id="${escapeHtml(t.id)}">Reject</button>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    function startTimesheetsSnapshot(){
      // If your schema uses createdAt, you can orderBy("createdAt","desc").
      // We try weekEndingISO first, and if it fails due to missing index, switch to no-order by.
      try{
        const qts = query(collection(db, "timesheets"), orderBy("weekEndingISO", "desc"));
        const unsub = onSnapshot(qts, (snap) => {
          const next = [];
          snap.forEach(d => next.push({ id: d.id, ...d.data() }));
          timesheets = next;
          renderTimesheets();
        }, (err) => {
          console.error(err);
          toast("Timesheets error", "Could not load timesheets (check index / rules).");
        });
        unsubscribers.push(unsub);
      }catch(err){
        console.error(err);
        const unsub = onSnapshot(collection(db, "timesheets"), (snap) => {
          const next = [];
          snap.forEach(d => next.push({ id: d.id, ...d.data() }));
          timesheets = next;
          renderTimesheets();
        });
        unsubscribers.push(unsub);
      }
    }

    async function updateTimesheetStatus(id, status){
      try{
        const ref = doc(db, "timesheets", id);
        const patch = {
          status,
          statusUpdatedAt: serverTimestamp(),
          statusUpdatedAtISO: new Date().toISOString()
        };
        if(status === "Approved"){
          patch.payrollReady = true;
          patch.payrollReadyAt = serverTimestamp();
          patch.payrollReadyAtISO = new Date().toISOString();
        }else{
          patch.payrollReady = false;
        }
        await updateDoc(ref, patch);
        toast("Updated", `Timesheet ${status}.`);
      }catch(err){
        console.error(err);
        toast("Update failed", "Check Firestore rules / permissions.");
      }
    }

    $("timesheetTable").addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-ts-action]");
      if(!btn) return;
      const action = btn.dataset.tsAction;
      const id = btn.dataset.id;

      if(action === "approve") updateTimesheetStatus(id, "Approved");
      if(action === "reject"){
        if(!confirm("Reject this timesheet?")) return;
        updateTimesheetStatus(id, "Rejected");
      }
    });

    /* ==========
       Init
       ========== */
    startSnapshots();
    startEmployeesSnapshot();
    startTimesheetsSnapshot();
  </script>
</body>
</html>
